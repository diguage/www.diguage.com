name: GitHub Pages
on:
  push:
    branches:
      - master
jobs:
  deploy:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Hugo 🐯
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Setup Ruby 💎
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1

      - name: Install AsciiDoctor 🐰
        run: |
          gem install asciidoctor
          gem install asciidoctor-diagram
          gem install asciidoctor-comment-links
          gem install rouge

      - name: Run Hugo 🔧
        run: |
          hugo --minify
      
      - name: Setup Node.js 🕸
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Compress Style 🍭
        run: |
          npm install cssnano-cli --global
          cd public/css
          cssnano asciidoctor.css asciidoctor.min.css
          rm -rf asciidoctor.css
          mv asciidoctor.min.css asciidoctor.css
          cssnano rouge-monokai.css rouge-monokai.min.css
          rm -rf rouge-monokai.css
          mv rouge-monokai.min.css rouge-monokai.css
          cssnano rouge-github.css rouge-github.min.css
          rm -rf rouge-github.css
          mv rouge-github.min.css rouge-github.css

      - name: Add Watermark to Images 🎖
        run: |
          sudo add-apt-repository -y ppa:strukturag/libheif
          sudo add-apt-repository -y ppa:strukturag/libde265
          sudo apt update -y
          sudo apt install -y libheif-dev
          sudo apt install -y libde265-dev
          t=$(mktemp) && wget 'https://dist.1-2.dev/imei.sh' -qO "$t" && sudo bash "$t" && rm "$t"
          cd public/images
          wget https://github.com/diguage/open-fonts/releases/download/latest/SourceCodePro-Semibold.otf
          # JPG
          find . -type f -name "*.jpg" | grep -v "goodbye-2019-hello-2020\|wx-jikerizhi-qrcode.jpg\|wx-jikerizhi.jpg" | sed "s/.jpg$//g" | xargs -I {} convert -compress JPEG2000 -strip -thumbnail 960 -quality 75 -font ./SourceCodePro-Semibold.otf -pointsize 30 -gravity southeast -fill "#DE282A" -draw 'text 15,18 "https://www.diguage.com"' {}.jpg {}-mark.jpg
          find . -type f -name "*.jpg" | grep -v "goodbye-2019-hello-2020\|wx-jikerizhi-qrcode.jpg\|wx-jikerizhi.jpg" | grep -v "\-mark.jpg" | xargs -I {} rm -f {} \;
          find . -type f -name "*-mark.jpg" | sed "s/-mark.jpg//g" | xargs -I {} mv {}-mark.jpg {}.jpg
          # JPEG
          find . -type f -name "*.jpeg" | sed "s/.jpeg$//g" | xargs -I {} convert -compress JPEG2000 -strip -thumbnail 960 -quality 75 -font ./SourceCodePro-Semibold.otf -pointsize 30 -gravity southeast -fill "#DE282A" -draw 'text 15,18 "https://www.diguage.com"' {}.jpeg {}-mark.jpeg
          find . -type f -name "*.jpeg" | grep -v "\-mark.jpeg" | xargs -I {} rm -f {} \;
          find . -type f -name "*-mark.jpeg" | sed "s/-mark.jpeg//g" | xargs -I {} mv {}-mark.jpeg {}.jpeg
          # TODO PNG 加完水印，文件增大很多
          # find . -type f -name "*.png" | sed "s/.png$//g" | xargs -I {} convert -depth 24 -define png:compression-filter=1 -define png:compression-level=9 -define png:compression-strategy=2 -font ./SourceCodePro-Semibold.otf -pointsize 30 -gravity southeast -fill "#DE282A" -draw 'text 15,18 "https://www.diguage.com"' {}.png {}-mark.png
          # find . -type f -name "*.png" | grep -v "\-mark.png" | xargs -I {} rm -f {} \;
          # find . -type f -name "*-mark.png" | sed "s/-mark.png//g" | xargs -I {} mv {}-mark.png {}.png

      - name: Generate Redirect HTML 🏓
        run: |
          cd public/archives/
          for i in {1..147} ; do echo "<meta http-equiv=\"refresh\" content=\"0;url=https://wordpress.diguage.com/archives/${i}.html\">" > ${i}.html; done

      - name: Rsync Deploy 🏹
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avzr --delete
          path: public/
          remote_path: ${{ secrets.DEPLOY_PATH }}
          remote_host: ${{ secrets.DEPLOY_HOST }}
          remote_port: ${{ secrets.DEPLOY_PORT }}
          remote_user: ${{ secrets.DEPLOY_USER }}
          remote_key: ${{ secrets.DEPLOY_KEY }}

      - name: Change Files Mod 🔐
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          port: ${{ secrets.DEPLOY_PORT }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            sudo chmod -R 777 *
          

      - name: Deploy 🚀
        continue-on-error: true
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages # The branch the action should deploy to.
          folder: public # The folder the action should deploy.
          single-commit: true
