---
title: "OpenJDK 21 å‡çº§æŒ‡å—"
date: 2024-05-06T19:50:22+08:00
draft: false
keywords: ["Java","OpenJDK","OpenJDK 21"]
tags: ["Java","JVM"]
categories: ["ç¼–ç¨‹è¯­è¨€","è½¯ä»¶å·¥ç¨‹"]
thumbnail: "images/java/java-21.jpeg"

weight: 1
---

https://openjdk.org/projects/jdk/21/[OpenJDK 21^] å·²ç»å‘å¸ƒåŠå¹´æœ‰ä½™ï¼Œåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œ https://openjdk.org/jeps/439[Generational ZGC^] ä¹Ÿä¸€èµ·å‘å¸ƒäº†ã€‚åœ¨ https://malloc.se/blog/zgc-jdk16[ZGC | What's new in JDK 16^] ä¸­ï¼Œ https://malloc.se/[Per LidÃ©n^] å®£ç§°ï¼Œå°† ZGC çš„æœ€å¤§åœé¡¿æ—¶é—´ä» 10ms é™ä½åˆ°äº† 1msã€‚å†åŠ ä¸Š https://www.diguage.com/post/gc-performance-incremental-qps/[JVM GC æ€§èƒ½æµ‹è¯•ï¼ˆäºŒï¼‰ï¼šé€’å¢æµé‡^] å’Œ https://www.diguage.com/post/gc-performance-real-qps/[JVM GC æ€§èƒ½æµ‹è¯•ï¼ˆä¸‰ï¼‰ï¼šçœŸå®æµé‡^] æ–‡ä¸­ï¼ŒGenZGC çš„æƒŠè‰³è¡¨ç°ï¼Œè¿™äº›ç§ç§å…ˆè¿›æŠ€æœ¯ï¼Œç€å®å……æ»¡è¯±æƒ‘ï¼Œå¿ä¸ä½æƒ³åƒå£èƒèŸ¹ ğŸ¦€ã€‚è¿™ç¯‡æ–‡ç« ï¼ŒDç“œå“¥å°±æ¥åˆ†äº«ä¸€ä¸‹ï¼Œè‡ªå·±åœ¨å‡çº§ OpenJDK 21 ä¸­çš„ä¸€äº›ç»éªŒã€‚

TIP: æœ¬æ–‡ä»…ä»‹ç»å‡çº§ OpenJDK çš„ç›¸å…³å†…å®¹ï¼ŒZGC åŸç†ç­‰ä¼šä¸“é—¨æ’°æ–‡ä»‹ç»ã€‚


== å‡çº§ä¾èµ–

ä¾èµ–å‡çº§ä¸æ˜¯ KPIï¼Œä¹Ÿä¸æ¶‰åŠéœ€æ±‚äº¤ä»˜ã€‚æ‰€ä»¥ï¼Œå¤§å¤šæ•°é¡¹ç›®çš„ä¾èµ–è‡ªä»é¡¹ç›®åˆ›å»ºåï¼Œå°±å¾ˆå°‘å‡çº§ã€‚å¦‚æœæƒ³æ¯”è¾ƒé¡ºåˆ©åœ°å°†é¡¹ç›®å‡çº§åˆ° OpenJDK 21ï¼Œé‚£ä¹ˆï¼Œå…ˆå°†é¡¹ç›®æ‰€ç”¨ä¾èµ–åšä¸€ä¸ªæ•´ä½“å‡çº§æ˜¯ä¸€ä¸ªäº‹åŠåŠŸå€çš„æ“ä½œã€‚å¯ä»¥ç›´æ¥ä½¿ç”¨ Maven å‘½ä»¤æ¥æ£€æŸ¥ä¾èµ–å¯ä»¥å‡çº§çš„æƒ…å†µï¼š

[source%nowrap,bash,{source_attr}]
----
mvn versions:display-dependency-updates
----

æ‰§è¡Œè¯¥å‘½ä»¤åï¼Œä¼šæœ‰å¦‚ä¸‹ç±»ä¼¼è¾“å‡ºï¼š

[source%nowrap,bash,{source_attr}]
----
# æ£€æŸ¥ä¾èµ–å‡çº§æƒ…å†µ
$ mvn versions:display-dependency-updates

# æ­¤å¤„çœç•¥ä¸€ä¸‡ä¸ªå­—
# @author: Dç“œå“¥ Â· https://www.diguage.com

[INFO]   org.springframework:spring-aop ......... 5.3.33 -> 6.1.6
[INFO]   org.springframework:spring-aspects ..... 5.3.33 -> 6.1.6
[INFO]   org.springframework:spring-beans ....... 5.3.33 -> 6.1.6
[INFO]   org.springframework:spring-context ..... 5.3.33 -> 6.1.6
[INFO]   org.springframework:spring-core ........ 5.3.33 -> 6.1.6
[INFO]   org.springframework:spring-jdbc ........ 5.3.33 -> 6.1.6
[INFO]   org.springframework:spring-web ......... 5.3.33 -> 6.1.6

[INFO]   org.mybatis:mybatis-2-spring ............ 1.1.0 -> 1.2.0
[INFO]   org.mybatis:mybatis-spring .............. 2.1.1 -> 2.1.2

[INFO]   org.junit.jupiter:junit-jupiter ........ 5.9.3 -> 5.10.2
[INFO]   org.junit.jupiter:junit-jupiter-api .... 5.9.3 -> 5.10.2
----

å¯ä»¥æ ¹æ®è¿™ä¸ªè¾“å‡ºæƒ…å†µï¼Œå°†ç›¸å…³ä¾èµ–åšä¸€ä¸ªæ•´ä½“å‡çº§ã€‚è¿™é‡Œå†æ³¨é‡æé†’ä¸‰ä¸ªæ–¹é¢ã€‚

=== Lombok

å¦‚æœé¡¹ç›®ä½¿ç”¨äº† Lombok ä¾èµ–ï¼ŒåŠ¡å¿…å°†å…¶å‡çº§åˆ° v1.18.30+ï¼Œä½äºæ­¤ç‰ˆæœ¬çš„ Lombok ä¼šæŠ¥é”™ï¼Œå…·ä½“åŸå› è§ï¼š https://github.com/projectlombok/lombok/issues/3393[[BUG\] lombok 1.8.26 incompatible with JDK21 Â· #3393^]ã€‚

=== Netty

å¦‚æœé¡¹ç›®ä½¿ç”¨äº† Nettyï¼Œå»ºè®®è¿›æ¥å°†å…¶å‡çº§åˆ° 4.1.93.Final+ã€‚OpenJDK 21 å¯¹ `DirectByteBuffer` çš„æ„é€ å‡½æ•°åšäº†æ”¹åŠ¨ï¼Œè¯¥ç‰ˆæœ¬åšäº†å…¼å®¹ã€‚ä¿®æ”¹æ—¥å¿—è§ï¼š https://netty.io/news/2023/05/25/4-1-93-Final.html[Netty.news: Netty 4.1.93.Final released^]ï¼Œä»£ç æ”¹åŠ¨è¯¦æƒ…è§ï¼š https://github.com/netty/netty/pull/13366[Adapt to DirectByteBuffer constructor in Java 21 #13366^]ã€‚

=== åå‘å…¼å®¹ JDK 8

å¦å¤–ï¼Œæé†’ä¸€ä¸‹ï¼Œå¦‚æœå¼€å‘ç¯å¢ƒè¿˜æ˜¯ä»¥ JDK 8 ä¸ºä¸»ï¼Œé‚£ä¹ˆ Spring æœ€å¥½å°±ä¸è¦å‡çº§åˆ° 6.xï¼Œèƒ½ä¸èƒ½å¿½ç•¥ç±»ä¼¼çš„ç›¸å…³é—®é¢˜å‘¢ï¼Ÿè§£å†³åŠæ³•è¯·å‚è€ƒï¼š https://www.diguage.com/post/intro-to-versions-maven-plugin/[Versions Maven æ’ä»¶ç®€ä»‹^]ï¼Œæ–‡ç« é‡Œå¯¹å¿½ç•¥ç‰ˆæœ¬ï¼Œä¸€é”®å‡çº§ç­‰æ“ä½œï¼Œéƒ½åšäº†æ¯”è¾ƒè¯¦ç»†çš„ä»‹ç»ã€‚

== `@javax.annotation.Resource`

ç›´æ¥å°†æœ¬åœ°ä½¿ç”¨çš„ JDK ç‰ˆæœ¬åˆ‡æ¢æˆ JDK 21 åï¼Œç¼–è¯‘å¤§æ¦‚ç‡ä¼šæŠ¥é”™ï¼Œæç¤ºæ‰¾ä¸åˆ° `javax.annotation.Resource`ï¼Œè¿™æ˜¯ç”±äº https://openjdk.org/jeps/320[JEP 320: Remove the Java EE and CORBA Modules^] ææ¡ˆï¼Œåœ¨ OpenJDK 11 ä¸­ç§»é™¤äº† JavaEE çš„ç›¸å…³å†…å®¹ã€‚æ‰€ä»¥ï¼Œéœ€è¦å°†å…¶ä½¿ç”¨ Jar åŒ…çš„å½¢å¼ä¸“é—¨å¼•ç”¨ä¸€ä¸‹ã€‚

[source%nowrap,xml,{source_attr}]
----
<dependency>
    <groupId>jakarta.annotation</groupId>
    <artifactId>jakarta.annotation-api</artifactId>
    <version>1.3.5</version>
</dependency>

<!-- æˆ–è€… -->
<!-- @author: Dç“œå“¥ Â· https://www.diguage.com -->

<dependency>
    <groupId>javax.annotation</groupId>
    <artifactId>javax.annotation-api</artifactId> <!--1-->
    <version>1.3.2</version>
</dependency>
----
<1> ä¸Šè¿°ä¸¤ä¸ªä¾èµ–ä»£ç åŸºæœ¬ä¸€æ ·ã€‚æ¨èä½¿ç”¨è¯¥ç‰ˆæœ¬ï¼Œä¸è€½è¯¯ä»¥ååŒæ—¶ä½¿ç”¨æ›´é«˜ç‰ˆæœ¬çš„ `jakarta.annotation:jakarta.annotation-api`ã€‚

=== Spring 6+ åŒæ—¶æ”¯æŒæ–°æ—§ç‰ˆçš„ `@Resource`

å¦å¤–ï¼Œæœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«è¯´æ˜ï¼šSpring 6+ æ”¯æŒæ–°ç‰ˆçš„ `jakarta.annotation.Resource` æ³¨è§£ï¼ŒåŒæ—¶è¿˜å…¼å®¹æ—§ç‰ˆçš„ `javax.annotation.Resource`ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š

TIP: æœ‰äº›æ–‡ç« æåˆ°ï¼ŒSpring 6 ä¸æ”¯æŒ `javax.annotation.Resource` æ³¨è§£ï¼Œä»ä¸‹é¢çš„ Spring ä»£ç æ¥çœ‹ï¼Œè¿™æ˜¯å®Œå…¨é”™è¯¯çš„ã€‚

.`CommonAnnotationBeanPostProcessor.java`
[source%collapsible,java,{source_attr}]
----
public class CommonAnnotationBeanPostProcessor extends InitDestroyAnnotationBeanPostProcessor
    implements InstantiationAwareBeanPostProcessor, BeanFactoryAware, Serializable {

  // Defensive reference to JNDI API for JDK 9+ (optional java.naming module)
  private static final boolean jndiPresent = ClassUtils.isPresent(
      "javax.naming.InitialContext", CommonAnnotationBeanPostProcessor.class.getClassLoader());

  private static final Set<Class<? extends Annotation>> resourceAnnotationTypes = CollectionUtils.newLinkedHashSet(3);

  @Nullable
  private static final Class<? extends Annotation> jakartaResourceType;

  @Nullable
  private static final Class<? extends Annotation> javaxResourceType;

  @Nullable
  private static final Class<? extends Annotation> ejbAnnotationType;

  static {
    jakartaResourceType = loadAnnotationType("jakarta.annotation.Resource");
    if (jakartaResourceType != null) {
      resourceAnnotationTypes.add(jakartaResourceType);
    }

    javaxResourceType = loadAnnotationType("javax.annotation.Resource");
    if (javaxResourceType != null) {
      resourceAnnotationTypes.add(javaxResourceType);
    }

    ejbAnnotationType = loadAnnotationType("jakarta.ejb.EJB");
    if (ejbAnnotationType != null) {
      resourceAnnotationTypes.add(ejbAnnotationType);
    }
  }

  private final Set<String> ignoredResourceTypes = new HashSet<>(1);

  private InjectionMetadata buildResourceMetadata(Class<?> clazz) {
    if (!AnnotationUtils.isCandidateClass(clazz, resourceAnnotationTypes)) {
      return InjectionMetadata.EMPTY;
    }

    List<InjectionMetadata.InjectedElement> elements = new ArrayList<>();
    Class<?> targetClass = clazz;

    do {
      final List<InjectionMetadata.InjectedElement> currElements = new ArrayList<>();

      ReflectionUtils.doWithLocalFields(targetClass, field -> {
        if (ejbAnnotationType != null && field.isAnnotationPresent(ejbAnnotationType)) {
          if (Modifier.isStatic(field.getModifiers())) {
            throw new IllegalStateException("@EJB annotation is not supported on static fields");
          }
          currElements.add(new EjbRefElement(field, field, null));
        }
        else if (jakartaResourceType != null && field.isAnnotationPresent(jakartaResourceType)) {
          if (Modifier.isStatic(field.getModifiers())) {
            throw new IllegalStateException("@Resource annotation is not supported on static fields");
          }
          if (!this.ignoredResourceTypes.contains(field.getType().getName())) {
            currElements.add(new ResourceElement(field, field, null));
          }
        }
        else if (javaxResourceType != null && field.isAnnotationPresent(javaxResourceType)) {
          if (Modifier.isStatic(field.getModifiers())) {
            throw new IllegalStateException("@Resource annotation is not supported on static fields");
          }
          if (!this.ignoredResourceTypes.contains(field.getType().getName())) {
            currElements.add(new LegacyResourceElement(field, field, null));
          }
        }
      });

      ReflectionUtils.doWithLocalMethods(targetClass, method -> {
        Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method);
        if (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) {
          return;
        }
        if (ejbAnnotationType != null && bridgedMethod.isAnnotationPresent(ejbAnnotationType)) {
          if (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) {
            if (Modifier.isStatic(method.getModifiers())) {
              throw new IllegalStateException("@EJB annotation is not supported on static methods");
            }
            if (method.getParameterCount() != 1) {
              throw new IllegalStateException("@EJB annotation requires a single-arg method: " + method);
            }
            PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);
            currElements.add(new EjbRefElement(method, bridgedMethod, pd));
          }
        }
        else if (jakartaResourceType != null && bridgedMethod.isAnnotationPresent(jakartaResourceType)) {
          if (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) {
            if (Modifier.isStatic(method.getModifiers())) {
              throw new IllegalStateException("@Resource annotation is not supported on static methods");
            }
            Class<?>[] paramTypes = method.getParameterTypes();
            if (paramTypes.length != 1) {
              throw new IllegalStateException("@Resource annotation requires a single-arg method: " + method);
            }
            if (!this.ignoredResourceTypes.contains(paramTypes[0].getName())) {
              PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);
              currElements.add(new ResourceElement(method, bridgedMethod, pd));
            }
          }
        }
        else if (javaxResourceType != null && bridgedMethod.isAnnotationPresent(javaxResourceType)) {
          if (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) {
            if (Modifier.isStatic(method.getModifiers())) {
              throw new IllegalStateException("@Resource annotation is not supported on static methods");
            }
            Class<?>[] paramTypes = method.getParameterTypes();
            if (paramTypes.length != 1) {
              throw new IllegalStateException("@Resource annotation requires a single-arg method: " + method);
            }
            if (!this.ignoredResourceTypes.contains(paramTypes[0].getName())) {
              PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);
              currElements.add(new LegacyResourceElement(method, bridgedMethod, pd));
            }
          }
        }
      });

      elements.addAll(0, currElements);
      targetClass = targetClass.getSuperclass();
    }
    while (targetClass != null && targetClass != Object.class);

    return InjectionMetadata.forElements(elements, clazz);
  }
}
----

== Nashorn JavaScript Engine

è§£å†³å®Œç¼–è¯‘é—®é¢˜åï¼Œå¯åŠ¨æŠ¥å¦‚ä¸‹å¼‚å¸¸ï¼š

[source%nowrap,{source_attr}]
----
2024-01-02 14:27:27.062 [main] ERROR com.diguage.laf.config.spring.config.JavaScriptListener[67] - failed invoking script script/logback.js
java.lang.NullPointerException: Cannot invoke "javax.script.ScriptEngine.put(String, Object)" because "engine" is null
----

è¿™æ˜¯å› ä¸º https://openjdk.org/jeps/372[JEP 372: Remove the Nashorn JavaScript Engine^] ææ¡ˆï¼Œä» OpenJDK 11 å¼€å§‹ï¼Œå°† Nashorn JavaScript Engine ç§»é™¤äº†ã€‚ç”±äºç›¸å…³åŠŸèƒ½ä½¿ç”¨äº† JavaScript å¼•æ“ï¼Œæ‰€ä»¥ï¼Œå°±æŠ¥äº† â€œCannot invoke "javax.script.ScriptEngine.put(String, Object)" because "engine" is nullâ€ é”™è¯¯ã€‚å¤„ç†åŠæ³•å¦‚ä¸Šï¼ŒåŠ å›ç›¸å…³çš„ä¾èµ–ï¼š

[source%nowrap,xml,{source_attr}]
----
<dependency>
    <groupId>org.openjdk.nashorn</groupId>
    <artifactId>nashorn-core</artifactId>
    <version>15.4</version>
</dependency>
----

== Java Validation API

æœ€è¿‘ï¼Œå¯¹ä¸€ä¸ªé¡¹ç›®å‡çº§ä¸­ï¼Œé‡åˆ°äº†å¦‚ä¸‹ä¸€ä¸ªæŠ¥é”™ï¼š

[source%nowrap,{source_attr}]
----
Caused by: java.lang.ExceptionInInitializerError: Exception javax.validation.ValidationException: HV000183: Unable to initialize 'javax.el.ExpressionFactory'. Check that you have the EL dependencies on the classpath, or use ParameterMessageInterpolator instead [in thread "BZ-22001-108-T-17"]
    at org.hibernate.validator.messageinterpolation.ResourceBundleMessageInterpolator.buildExpressionFactory(ResourceBundleMessageInterpolator.java:199)
    at org.hibernate.validator.messageinterpolation.ResourceBundleMessageInterpolator.<init>(ResourceBundleMessageInterpolator.java:94)
    at org.hibernate.validator.internal.engine.AbstractConfigurationImpl.getDefaultMessageInterpolator(AbstractConfigurationImpl.java:570)
    at org.hibernate.validator.internal.engine.AbstractConfigurationImpl.getDefaultMessageInterpolatorConfiguredWithClassLoader(AbstractConfigurationImpl.java:790)
    at org.hibernate.validator.internal.engine.AbstractConfigurationImpl.getMessageInterpolator(AbstractConfigurationImpl.java:480)
    at org.hibernate.validator.internal.engine.ValidatorFactoryImpl.<init>(ValidatorFactoryImpl.java:151)
    at org.hibernate.validator.HibernateValidator.buildValidatorFactory(HibernateValidator.java:38)
    at org.hibernate.validator.internal.engine.AbstractConfigurationImpl.buildValidatorFactory(AbstractConfigurationImpl.java:430)
----

è¿™æ˜¯ç”±äº Bean Validation å¯¼è‡´çš„é—®é¢˜ã€‚å°†ä¾èµ–å‡çº§åˆ°å¦‚ä¸‹ç‰ˆæœ¬å³å¯ï¼š

[source%nowrap,xml,{source_attr}]
----
<!-- @author: Dç“œå“¥ Â· https://www.diguage.com -->
<dependency>
    <groupId>jakarta.validation</groupId>
    <artifactId>jakarta.validation-api</artifactId>
    <version>3.0.2</version> <!--1-->
</dependency>
<dependency>
    <groupId>org.hibernate.validator</groupId>
    <artifactId>hibernate-validator</artifactId>
    <version>7.0.5.Final</version><!--1-->
</dependency>
<dependency>
    <groupId>org.hibernate.validator</groupId>
    <artifactId>hibernate-validator-annotation-processor</artifactId>
    <version>7.0.5.Final</version><!--1-->
</dependency>
----
<1> é€‰æ‹©è¯¥ç‰ˆæœ¬æ˜¯ç”±äºè¯¥ç‰ˆæœ¬æ”¯æŒ Java8ï¼Œè¿™æ ·å¯ä»¥è®©é¡¹ç›®æ— æ„Ÿå‡çº§åˆ° OpenJDK21ã€‚

ç”±äºè¯¥ç‰ˆæœ¬çš„ Bean Validation çš„åŸºç¡€åŒ…åå·²ç»ä» `javax.` æ”¹ä¸º `jakarta.`ï¼Œæ‰€ä»¥ï¼Œéœ€è¦ä¿®æ”¹ç¨‹åºï¼Œè¿™éƒ¨åˆ†å·¥ä½œå·²ç»æœ‰ç›¸å…³ç¨‹åºæ¥è‡ªåŠ¨å®Œæˆï¼Œæ•¬è¯·å…³æ³¨ï¼š https://www.diguage.com/post/optimize-code-using-openrewrite/[ä½¿ç”¨ OpenRewrite ä¼˜åŒ–ä»£ç ^]ã€‚


== JAXB

åŒæ ·æ˜¯ç”±äº https://openjdk.org/jeps/320[JEP 320: Remove the Java EE and CORBA Modules^] ææ¡ˆï¼Œ åœ¨ OpenJDK 11 ä¸­ç§»é™¤äº† JavaEE çš„ç›¸å…³å†…å®¹ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬ https://jcp.org/en/jsr/detail?id=222[JAXB^]ã€‚ç¼–è¯‘å¯èƒ½ä¼šæŠ¥é”™ï¼Œå¢åŠ å¦‚ä¸‹ä¾èµ–å³å¯ï¼š

[source%nowrap,xml,{source_attr}]
----
<dependency>
    <groupId>org.glassfish.jaxb</groupId>
    <artifactId>jaxb-runtime</artifactId>
    <version>2.3.9</version>
</dependency>
----

[#jigsaw]
== Java æ¨¡å—åŒ–

å¦‚æœæ„å»ºä¸€åˆ‡é¡ºåˆ©ï¼Œä»¥ä¸ºå¯ä»¥æ­£å¸¸å¯åŠ¨è¿è¡Œç¨‹åºï¼Œç»“æœå´å¯èƒ½æŠ¥å¦‚ä¸‹é”™è¯¯ï¼š

[source%nowrap,{source_attr}]
----
Caused by: java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not "opens java.lang" to unnamed module @66f57048
  at java.base/java.lang.reflect.AccessibleObject.throwInaccessibleObjectException(AccessibleObject.java:391)
----

è¿™æ˜¯ç”±äºåœ¨ JDK 9 ä¸­å¼•å…¥çš„ https://openjdk.org/projects/jigsaw/spec/sotms/[Java Platform Module System^] å¯¼è‡´çš„ï¼Œè¯¥åè®®å¯¹ Java çš„å°è£…æ€§åšäº†è¿›ä¸€æ­¥å¢å¼ºã€‚æ›´è¯¦ç»†çš„å†…å®¹å¯ä»¥çœ‹ï¼š â‘  åè®®ï¼š https://openjdk.org/projects/jigsaw/spec/[Java Platform Module System JSR (376)^] â‘¡ å®ç°ï¼š https://openjdk.org/jeps/261[JEP 261: Module System^] â‘¢ è§£é‡Šï¼š https://nipafx.dev/java-modules-reflection-vs-encapsulation/[Reflection vs Encapsulation^]ã€‚

å…·ä½“åˆ°è¯¥é—®é¢˜çš„è§£å†³åŠæ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼šå°†æ²¡å¼€æ”¾çš„æ¨¡å—å¼ºåˆ¶å¯¹å¤–å¼€æ”¾ã€‚æœ‰ä¸¤ä¸ªå‚æ•°é€‰é¡¹ï¼š

. `--add-exports` å¯¼å‡ºåŒ…ï¼Œæ„å‘³ç€å…¶ä¸­çš„æ‰€æœ‰å…¬å…±ç±»å‹å’Œæˆå‘˜éƒ½å¯ä»¥åœ¨ç¼–è¯‘å’Œè¿è¡Œæ—¶è®¿é—®ã€‚
. `--add-opens` æ‰“å¼€åŒ…ï¼Œæ„å‘³ç€å…¶ä¸­çš„æ‰€æœ‰ç±»å‹å’Œæˆå‘˜ï¼ˆä¸ä»…æ˜¯å…¬å…±ç±»å‹ï¼‰éƒ½å¯ä»¥åœ¨è¿è¡Œæ—¶è®¿é—®ã€‚

ä¸¤è€…çš„åŒºåˆ«åœ¨äº `--add-opens` å¼€æ”¾çš„æ›´åŠ å½»åº•ï¼Œä¸ä»… `public` ç±»å‹ã€å˜é‡åŠæ–¹æ³•å¯ä»¥è®¿é—®ï¼Œå°±è¿é `public` å…ƒç´ ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ `setAccessible(true)` åä¹Ÿå¯ä»¥è®¿é—®ã€‚ç®€å•èµ·è§ï¼Œç›´æ¥ä½¿ç”¨ `--add-opens` å³å¯ã€‚ç›¸å…³çš„å‚æ•°åœ¨å¼‚å¸¸ä¸­ä¹Ÿæé†’å‡ºæ¥äº†ï¼š `module java.base` å’Œ `"opens java.lang"`ï¼Œç»“åˆèµ·æ¥ï¼Œç›´æ¥è¿™æ ·é…ç½®ï¼šåœ¨ `java` æ˜äº†å¯åŠ¨å‚æ•°ä¸­ï¼Œå¢åŠ  `--add-opens java.base/java.lang=ALL-UNNAMED` é€‰é¡¹å³å¯ã€‚

ä¸‹é¢å†åˆ—å‡ºå‡ ä¸ªç›¸å…³ç¤ºä¾‹ï¼š

=== `java.base/java.util`

é”™è¯¯æ—¥å¿—ï¼š

[source%nowrap,{source_attr}]
----
Caused by: java.lang.reflect.InaccessibleObjectException: Unable to make field protected int[] java.util.Calendar.fields accessible: module java.base does not "opens java.util" to unnamed module @21282ed8
----

å¯åŠ¨å‚æ•°ï¼š `--add-opens java.base/java.util=ALL-UNNAMED`ã€‚

=== `java.base/java.math`

é”™è¯¯æ—¥å¿—ï¼š

[source%nowrap,{source_attr}]
----
java.lang.reflect.InaccessibleObjectException: Unable to make field final int[] java.math.BigInteger.mag accessible: module java.base does not "opens java.math" to unnamed module @21282ed8
----

å¯åŠ¨å‚æ•°ï¼š `--add-opens java.base/java.math=ALL-UNNAMED`ã€‚

== æ„å»ºä¸æµ‹è¯•

ä¸Šé¢ä»‹ç»äº†ç¨‹åºç›¸å…³çš„é”™è¯¯åŠè§£å†³åŠæ³•ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹æ„å»ºæµç¨‹ä¸­å‡ºç°çš„é—®é¢˜ã€‚

=== maven-compiler-plugin é…ç½®

å¦‚æœé¡¹ç›®ä¸­ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µåšäº†ä¸€äº›æ‰©å±•æ€§çš„ä¸œè¥¿ï¼Œé‚£ä¹ˆå°±å¯èƒ½è§¦å‘ä¸Šé¢ <<jigsaw>> ä¸­æè¿°çš„é—®é¢˜ã€‚ç±»ä¼¼å¦‚ä¸‹æ—¥å¿—ï¼š

[source%nowrap,{source_attr}]
----
java.lang.IllegalAccessError: class com.diguage.plugin.lombok.ToStringProcessor (in unnamed module @0x551976c2)
cannot access class com.sun.tools.javac.api.JavacTrees (in module jdk.compiler)
because module jdk.compiler does not export com.sun.tools.javac.api to unnamed module @0x551976c2
        at com.diguage.plugin.lombok.ToStringProcessor.init(ToStringProcessor.java:44)
----

è¿™ä¸ªé—®é¢˜ä¹Ÿå¯ä»¥é€šè¿‡å¢åŠ å‚æ•°æ¥å®Œæˆã€‚ä¸è¿‡ï¼Œè¿™ä¸ªå‚æ•°éœ€è¦åœ¨ `pom.xml` ä¸­é€šè¿‡ç»™ maven-compiler-plugin æ’ä»¶å¢åŠ é…ç½®çš„æ–¹å¼æ¥æï¼Œå¦‚ä¸‹ï¼š

[source%nowrap,xml,{source_attr}]
----
<!-- @author: Dç“œå“¥ Â· https://www.diguage.com -->
<plugin>
  <groupId>org.apache.maven.plugins</groupId>
  <artifactId>maven-compiler-plugin</artifactId>
  <version>3.13.0</version>
  <configuration>
      <showWarnings>true</showWarnings>
      <fork>true</fork>
      <compilerArgs>
        <arg>-J--add-opens=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED</arg>
      </compilerArgs>
  </configuration>
</plugin>
----

ä½ç‰ˆæœ¬çš„ Lombok ä¹Ÿä¼šé‡åˆ°ç±»ä¼¼é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡å‡çº§åˆ°é«˜ç‰ˆæœ¬æ¥è§£å†³ã€‚å®åœ¨è§£å†³ä¸äº†ï¼Œå…œåº•æ–¹æ¡ˆä¹Ÿå¯ä»¥ç›´æ¥åœ¨è¿™é‡Œé…ç½®ã€‚

=== maven-surefire-plugin é…ç½®

ä½¿ç”¨ Maven è¿›è¡Œæ„å»ºæˆ–è€…ä¸“é—¨æ‰§è¡Œæµ‹è¯•æ—¶ï¼Œå¯èƒ½ä¹Ÿä¼šé‡åˆ° <<jigsaw>> ä¸­æè¿°çš„é—®é¢˜ã€‚åŒæ ·ï¼Œå¯ä»¥é€šè¿‡åœ¨ `pom.xml` ä¸­é…ç½® maven-surefire-plugin æ’ä»¶çš„æ–¹å¼æ¥è§£å†³ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

[source%nowrap,xml,{source_attr}]
----
<!-- @author: Dç“œå“¥ Â· https://www.diguage.com -->
<plugin>
  <groupId>org.apache.maven.plugins</groupId>
  <artifactId>maven-surefire-plugin</artifactId>
  <version>3.2.5</version>
  <configuration>
      <skipTests>true</skipTests>
      <includes>
        <include>**/*Test.java</include>
      </includes>
      <argLine>
        --add-opens java.base/java.lang=ALL-UNNAMED
        --add-opens java.base/java.util=ALL-UNNAMED
        --add-opens java.base/java.math=ALL-UNNAMED
        --add-opens java.base/java.time=ALL-UNNAMED
      </argLine>
  </configuration>
</plugin>
----

=== IntelliJ IDEA é…ç½®

åœ¨ IntelliJ IDEA è¿è¡Œç¨‹åºï¼Œå¤§æ¦‚ç‡ä¹Ÿä¼šæŠ¥é”™ï¼Œå¯ä»¥é€šè¿‡åœ¨ â€œVM Optionâ€ é…ç½®é¡¹ä¸­ï¼Œå¢åŠ  <<jigsaw>> æåˆ°çš„ç›¸å…³å¯åŠ¨å‚æ•°å³å¯æ­£å¸¸å¯åŠ¨ã€‚

== æŠ€å·§

è¿˜æœ‰ä¸€ä¸ªä¸æ˜¯é—®é¢˜çš„é—®é¢˜éœ€è¦è§£å†³ä¸€ä¸‹ï¼šç›®å‰å¤§å¤šæ•°å¼€å‘äººå‘˜ç”¨çš„è¿˜æ˜¯ JDK 8ï¼Œå¦‚ä½•å¯ä»¥è®©å¤§å®¶æ— ç—›æˆ–è€…æ— æ„Ÿå‡çº§å‘¢ï¼Ÿ

Dç“œå“¥åˆ†äº«ä¸€ä¸ªå°æŠ€å·§ï¼šå¯ä»¥ä½¿ç”¨ Maven çš„ `profile` æœºåˆ¶ï¼Œè®©å…¶æ ¹æ® JDK ç‰ˆæœ¬å·ï¼Œè‡ªåŠ¨æ¿€æ´»ä¸åŒçš„é…ç½®ã€‚å…·ä½“å…¥æˆä¸‹ï¼š

[source%nowrap,xml,{source_attr}]
----
<!-- @author: Dç“œå“¥ Â· https://www.diguage.com -->
<profile>
  <id>Java1.8</id>
  <activation>
    <!-- åœ¨ JDK 1.8 æ—¶è‡ªåŠ¨æ¿€æ´»-->
    <jdk>1.8</jdk>
  </activation>
  <properties>
    <spring.version>5.3.33</spring.version> <!--1-->
  </properties>
  <!-- åœ¨çˆ¶ POM ä¸­ä½¿ç”¨ dependencyManagement ç”Ÿå‘½ -->
  <!-- åœ¨éœ€è¦çš„å­æ¨¡å—ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨ -->
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>javax.servlet</groupId> <!--1-->
        <artifactId>javax.servlet-api</artifactId>
        <version>4.0.1</version>
        <scope>provided</scope>
      </dependency>
    </dependencies>
  </dependencyManagement>
  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>3.2.5</version>
        <configuration>
        <includes>
          <include>**/*Test.java</include>
        </includes>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>3.13.0</version>
        <configuration>
          <showWarnings>true</showWarnings>
          <fork>true</fork>
        </configuration>
      </plugin>
    </plugins>
  </build>
</profile>

<!-- @author: Dç“œå“¥ Â· https://www.diguage.com -->
<profile>
  <id>Java21</id>
  <activation>
    <jdk>[21,)</jdk>
  </activation>
  <properties>
    <spring.version>6.0.19</spring.version> <!--1-->
  </properties>
  <!-- åœ¨çˆ¶ POM ä¸­ä½¿ç”¨ dependencyManagement ç”Ÿå‘½ -->
  <!-- åœ¨éœ€è¦çš„å­æ¨¡å—ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨ -->
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>jakarta.servlet</groupId> <!--1-->
        <artifactId>jakarta.servlet-api</artifactId>
        <version>6.0.0</version>
        <scope>provided</scope>
      </dependency>
      <dependency>
        <groupId>org.openjdk.nashorn</groupId>
        <artifactId>nashorn-core</artifactId>
        <version>15.4</version>
      </dependency>
      <dependency>
        <groupId>org.glassfish.jaxb</groupId>
        <artifactId>jaxb-runtime</artifactId>
        <version>2.3.9</version>
      </dependency>
    </dependencies>
  </dependencyManagement>
  <!--åœ¨å‡ ä¹æ‰€æœ‰æ¨¡å—éƒ½ä¼šä½¿ç”¨ï¼Œæ‰€ä»¥ï¼Œç›´æ¥åœ¨çˆ¶ POM ä¸­å£°æ˜ä¾èµ– -->
  <dependencies>
    <dependency>
      <groupId>javax.annotation</groupId>
      <artifactId>javax.annotation-api</artifactId>
      <version>1.3.2</version>
    </dependency>
  </dependencies>
  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>3.2.5</version>
        <configuration>
        <includes>
          <include>**/*Test.java</include>
        </includes>
        <argLine>
          --add-opens java.base/java.lang=ALL-UNNAMED
          --add-opens java.base/java.util=ALL-UNNAMED
          --add-opens java.base/java.math=ALL-UNNAMED
          --add-opens java.base/java.time=ALL-UNNAMED
        </argLine>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>3.13.0</version>
        <configuration>
        <showWarnings>true</showWarnings>
        <fork>true</fork>
        <compilerArgs>
          <arg>-J--add-opens=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED</arg>
        </compilerArgs>
        </configuration>
      </plugin>
    </plugins>
  </build>
</profile>
----
<1> å¼€å‘æœºä½¿ç”¨ JDK 8ï¼Œæ‰€ä»¥ï¼Œä½¿ç”¨ Spring 5 + Servletï¼›æ­£å¼ç¯å¢ƒä½¿ç”¨ OpenJDK 21ï¼Œæ‰€ä»¥ï¼Œä½¿ç”¨ Spring 6 + Jakarta Servletã€‚

ä½¿ç”¨ä¸Šé¢çš„é…ç½®ï¼Œåªè¦ç¨‹åºæ²¡æœ‰ç›´æ¥ä½¿ç”¨ Servlet APIï¼Œå°±å¯ä»¥åœ¨ JDK 8 å’Œ OpenJDK 21 ä¹‹é—´è‡ªç”±åˆ‡æ¢ã€‚æ­£åœ¨åšåˆ°å¹³ç¨³å‡çº§ã€‚

== ç§‘æŠ€ä¸ç‹ æ´»

æ–‡ç« æœ€åï¼Œåœ¨æ•´ä¸€ç‚¹ç§‘æŠ€ä¸ç‹ æ´»ã€‚

=== EMT4J

å…³äº JDK å‡çº§çš„äº‹é¡¹ï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šæ£€æŸ¥é¡¹ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæœ€å¥½æœ‰å·¥å…·èƒ½è‡ªåŠ¨æ£€æŸ¥è¿™äº›é¡¹ç›®ã€‚å…³äºè¿™ä¸ªé—®é¢˜ï¼Œé˜¿é‡Œå·´å·´å¼€å‘äº† Migration Toolkit for Javaï¼Œç°åœ¨å·²ç»æç»™ Eclipse åŸºé‡‘ä¼šäº†ï¼Œä»£ç åœ¨ https://github.com/adoptium/emt4j[adoptium/emt4j: Eclipse Migration Toolkit for Java^]ã€‚è¿™ä¸ªå·¥å…·è¿˜æä¾›äº† Maven æ’ä»¶ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªæ’ä»¶æ¥åšæ£€æŸ¥å·¥ä½œã€‚å…·ä½“é…ç½®å¦‚ä¸‹ï¼š

[source%nowrap,xml,{source_attr}]
----
<plugin>
  <groupId>org.eclipse.emt4j</groupId>
  <artifactId>emt4j-maven-plugin</artifactId>
  <version>0.8.0</version>
  <!-- å¯ä»¥å°†æ£€æŸ¥è¿‡ç¨‹ç»‘å®šåˆ° Maven æ„å»ºå‘¨æœŸçš„æŸä¸ªé˜¶æ®µï¼Œä½†ä¸å»ºè®®ã€‚ -->
  <!-- <executions>-->
  <!--   <execution>-->
  <!--     <phase>process-test-classes</phase>-->
  <!--     <goals>-->
  <!--       <goal>check</goal>-->
  <!--     </goals>-->
  <!--   </execution>-->
  <!-- </executions>-->
  <configuration>
      <!-- å½“å‰ç‰ˆæœ¬ -->
      <fromVersion>8</fromVersion>
      <!-- æœŸæœ›å‡çº§ç‰ˆæœ¬ -->
      <toVersion>21</toVersion>
      <outputFile>report.html</outputFile>
  </configuration>
</plugin>
----

ç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å°±å¯ä»¥å¯¹åº”ç”¨ç¨‹åºåšä¸ªå…¨é¢æ£€æŸ¥ï¼š

[source%nowrap,bash,{source_attr}]
----
mvn emt4j:check
----

åœ¨æ„å»ºç›®å½•é‡Œæ‰¾ `report.html` æ–‡ä»¶ï¼Œä¼šæœ‰ä¸€ä¸ªä¸ªè¶…é•¿çš„æ–‡ä»¶ï¼Œåˆ—å‡ºæˆåƒä¸Šç™¾ä¸ªé—®é¢˜ã€‚ï¼ˆDç“œå“¥æ£€æŸ¥çš„ä¸€ä¸ªåº”ç”¨æœ‰ 2600 è¡Œçš„æ£€æŸ¥ç»“æœã€‚ï¼‰å…¶å®ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œå¤§éƒ¨åˆ†é—®é¢˜å¯ä»¥å¿½ç•¥ã€‚ä½†æ˜¯ï¼Œä½ å¾ˆæ¸…æ¥šå¯èƒ½æ½œåœ¨çš„é—®é¢˜ï¼Œå°±åƒåƒè¥¿è¯çš„æ—¶å€™ï¼Œçœ‹åˆ°ä¸€å¤§å †ä¸è‰¯ååº”åï¼Œåƒèµ·æ¥æ›´æ”¾å¿ƒã€‚

=== OpenRewrite

ä¸Šè¿°å·¥å…·æ£€æŸ¥å‡ºæ¥çš„ä¸€éƒ¨åˆ†é—®é¢˜ï¼Œå¯ä»¥ç”¨å¦å¤–â€œç§‘æŠ€ä¸ç‹ æ´»â€è§£å†³ï¼Œé™äºç¯‡å¹…ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚æ•¬è¯·å…³æ³¨ï¼š https://www.diguage.com/post/optimize-code-using-openrewrite/[ä½¿ç”¨ OpenRewrite ä¼˜åŒ–ä»£ç ^]ã€‚

== å‚è€ƒèµ„æ–™

. https://hibernate.org/validator/releases/7.0/[Hibernate Validator 7.0^]
. https://stackoverflow.com/a/41265267/951836[reflection - How to solve InaccessibleObjectException ("Unable to make {member} accessible: module {A} does not 'opens {package}' to {B}") on Java 9?^]
. https://nipafx.dev/java-modules-reflection-vs-encapsulation/[Reflection vs Encapsulation^]
. https://blog.csdn.net/maiya_yayaya/article/details/132297860#t7[java 8 - java 17 å‡çº§æŒ‡åŒ—^]
. https://www.cnblogs.com/stcweb/articles/15114266.html[module java.base does not "opens java.lang" to unnamed module^]
. https://stackoverflow.com/a/51286665/951836[java - What is the difference (or relation) between JLS, JSR and JEP?^]
