---
title: "å¦‚ä¸é¡ºæ»‘å‡çº§åˆ° OpenJDK 21"
date: 2024-04-22T19:50:22+08:00
draft: true
keywords: ["Java","OpenJDK","OpenJDK 21"]
tags: ["Java","JVM"]
categories: ["ç¼–ç¨‹è¯­è¨€","è½¯ä»¶å·¥ç¨‹"]
thumbnail: "images/java/java-21.jpeg"

weight: 1
---

https://openjdk.org/projects/jdk/21/[OpenJDK 21^] å·²ç»å‘å¸ƒåŠå¹´æœ‰ä½™ï¼Œåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œ https://openjdk.org/jeps/439[Generational ZGC^] ä¹Ÿä¸€èµ·å‘å¸ƒäº†ã€‚åœ¨ https://malloc.se/blog/zgc-jdk16[ZGC | What's new in JDK 16^] ä¸­ï¼Œ https://malloc.se/[Per LidÃ©n^] å®£ç§°ï¼Œå°† ZGC çš„æœ€å¤§åœé¡¿æ—¶é—´ä» 10ms é™ä½åˆ°äº† 1msã€‚è¿™äº›ç§ç§å…ˆè¿›æŠ€æœ¯ï¼Œç€å®å……æ»¡è¯±æƒ‘ï¼Œå¿ä¸ä½æƒ³åƒå£èƒèŸ¹ğŸ¦€ã€‚

TIP: æœ¬æ–‡ä»…ä»…ä»‹ç»å‡çº§ OpenJDK çš„ç›¸å…³å†…å®¹ï¼Œè‡³äº ZGC ç­‰æŠ€æœ¯ç»†èŠ‚ï¼Œåç»­å†æ’°æ–‡ä»‹ç»ã€‚

ç”±äº Spring Boot é¡¹ç›®ä¸ Java Web é¡¹ç›®æœ‰å·®å¼‚ï¼Œä¹Ÿæœ‰å…±æ€§ã€‚æ‰€ä»¥ï¼Œåˆ†å¼€æ¥è®²ã€‚

== å‡çº§é€šç”¨å†…å®¹

=== `@javax.annotation.Resource`

ç›´æ¥å°†æœ¬åœ°ä½¿ç”¨çš„ JDK ç‰ˆæœ¬åˆ‡æ¢æˆ JDK 21 åï¼Œç¼–è¯‘å¤§æ¦‚ç‡ä¼šæŠ¥é”™ï¼Œæç¤ºæ‰¾ä¸åˆ° `javax.annotation.Resource`ï¼Œè¿™æ˜¯ç”±äº https://openjdk.org/jeps/320[JEP 320: Remove the Java EE and CORBA Modules^] ææ¡ˆï¼Œåœ¨ OpenJDK 11 ä¸­ç§»é™¤äº† JavaEE çš„ç›¸å…³å†…å®¹ã€‚æ‰€ä»¥ï¼Œéœ€è¦å°†å…¶ä½¿ç”¨ Jar åŒ…çš„å½¢å¼ä¸“é—¨å¼•ç”¨ä¸€ä¸‹ã€‚

[source%nowrap,xml,{source_attr}]
----
<dependency>
    <groupId>jakarta.annotation</groupId>
    <artifactId>jakarta.annotation-api</artifactId> <!--1-->
    <version>1.3.5</version>
</dependency>

<!-- æˆ–è€… -->

<dependency>
    <groupId>javax.annotation</groupId>
    <artifactId>javax.annotation-api</artifactId>
    <version>1.3.2</version>
</dependency>
----
<1> ä¸Šè¿°ä¸¤ä¸ªä¾èµ–ä»£ç åŸºæœ¬ä¸€æ ·ã€‚æ¨èä½¿ç”¨è¯¥ç‰ˆæœ¬ä»¥åï¼Œåç»­å‡çº§ç›´æ¥æ”¹ç‰ˆæœ¬å·å³å¯ã€‚

å¦å¤–ï¼Œæœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«è¯´æ˜ï¼šSpring 6+ æ”¯æŒæ–°ç‰ˆçš„ `jakarta.annotation.Resource` æ³¨è§£ï¼ŒåŒæ—¶è¿˜å…¼å®¹æ—§ç‰ˆçš„ `javax.annotation.Resource`ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š

.`CommonAnnotationBeanPostProcessor.java`
[source%nowrap,java,{source_attr}]
----
public class CommonAnnotationBeanPostProcessor extends InitDestroyAnnotationBeanPostProcessor
		implements InstantiationAwareBeanPostProcessor, BeanFactoryAware, Serializable {

	// Defensive reference to JNDI API for JDK 9+ (optional java.naming module)
	private static final boolean jndiPresent = ClassUtils.isPresent(
			"javax.naming.InitialContext", CommonAnnotationBeanPostProcessor.class.getClassLoader());

	private static final Set<Class<? extends Annotation>> resourceAnnotationTypes = CollectionUtils.newLinkedHashSet(3);

	@Nullable
	private static final Class<? extends Annotation> jakartaResourceType;

	@Nullable
	private static final Class<? extends Annotation> javaxResourceType;

	@Nullable
	private static final Class<? extends Annotation> ejbAnnotationType;

	static {
		jakartaResourceType = loadAnnotationType("jakarta.annotation.Resource");
		if (jakartaResourceType != null) {
			resourceAnnotationTypes.add(jakartaResourceType);
		}

		javaxResourceType = loadAnnotationType("javax.annotation.Resource");
		if (javaxResourceType != null) {
			resourceAnnotationTypes.add(javaxResourceType);
		}

		ejbAnnotationType = loadAnnotationType("jakarta.ejb.EJB");
		if (ejbAnnotationType != null) {
			resourceAnnotationTypes.add(ejbAnnotationType);
		}
	}

	private final Set<String> ignoredResourceTypes = new HashSet<>(1);

	private InjectionMetadata buildResourceMetadata(Class<?> clazz) {
		if (!AnnotationUtils.isCandidateClass(clazz, resourceAnnotationTypes)) {
			return InjectionMetadata.EMPTY;
		}

		List<InjectionMetadata.InjectedElement> elements = new ArrayList<>();
		Class<?> targetClass = clazz;

		do {
			final List<InjectionMetadata.InjectedElement> currElements = new ArrayList<>();

			ReflectionUtils.doWithLocalFields(targetClass, field -> {
				if (ejbAnnotationType != null && field.isAnnotationPresent(ejbAnnotationType)) {
					if (Modifier.isStatic(field.getModifiers())) {
						throw new IllegalStateException("@EJB annotation is not supported on static fields");
					}
					currElements.add(new EjbRefElement(field, field, null));
				}
				else if (jakartaResourceType != null && field.isAnnotationPresent(jakartaResourceType)) {
					if (Modifier.isStatic(field.getModifiers())) {
						throw new IllegalStateException("@Resource annotation is not supported on static fields");
					}
					if (!this.ignoredResourceTypes.contains(field.getType().getName())) {
						currElements.add(new ResourceElement(field, field, null));
					}
				}
				else if (javaxResourceType != null && field.isAnnotationPresent(javaxResourceType)) {
					if (Modifier.isStatic(field.getModifiers())) {
						throw new IllegalStateException("@Resource annotation is not supported on static fields");
					}
					if (!this.ignoredResourceTypes.contains(field.getType().getName())) {
						currElements.add(new LegacyResourceElement(field, field, null));
					}
				}
			});

			ReflectionUtils.doWithLocalMethods(targetClass, method -> {
				Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method);
				if (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) {
					return;
				}
				if (ejbAnnotationType != null && bridgedMethod.isAnnotationPresent(ejbAnnotationType)) {
					if (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) {
						if (Modifier.isStatic(method.getModifiers())) {
							throw new IllegalStateException("@EJB annotation is not supported on static methods");
						}
						if (method.getParameterCount() != 1) {
							throw new IllegalStateException("@EJB annotation requires a single-arg method: " + method);
						}
						PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);
						currElements.add(new EjbRefElement(method, bridgedMethod, pd));
					}
				}
				else if (jakartaResourceType != null && bridgedMethod.isAnnotationPresent(jakartaResourceType)) {
					if (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) {
						if (Modifier.isStatic(method.getModifiers())) {
							throw new IllegalStateException("@Resource annotation is not supported on static methods");
						}
						Class<?>[] paramTypes = method.getParameterTypes();
						if (paramTypes.length != 1) {
							throw new IllegalStateException("@Resource annotation requires a single-arg method: " + method);
						}
						if (!this.ignoredResourceTypes.contains(paramTypes[0].getName())) {
							PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);
							currElements.add(new ResourceElement(method, bridgedMethod, pd));
						}
					}
				}
				else if (javaxResourceType != null && bridgedMethod.isAnnotationPresent(javaxResourceType)) {
					if (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) {
						if (Modifier.isStatic(method.getModifiers())) {
							throw new IllegalStateException("@Resource annotation is not supported on static methods");
						}
						Class<?>[] paramTypes = method.getParameterTypes();
						if (paramTypes.length != 1) {
							throw new IllegalStateException("@Resource annotation requires a single-arg method: " + method);
						}
						if (!this.ignoredResourceTypes.contains(paramTypes[0].getName())) {
							PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);
							currElements.add(new LegacyResourceElement(method, bridgedMethod, pd));
						}
					}
				}
			});

			elements.addAll(0, currElements);
			targetClass = targetClass.getSuperclass();
		}
		while (targetClass != null && targetClass != Object.class);

		return InjectionMetadata.forElements(elements, clazz);
	}
}
----

=== Nashorn JavaScript Engine

è§£å†³å®Œç¼–è¯‘é—®é¢˜åï¼Œå¯åŠ¨æŠ¥å¦‚ä¸‹å¼‚å¸¸ï¼š

[source%nowrap,{source_attr}]
----
2024-01-02 14:27:27.062 [main] ERROR com.diguage.laf.config.spring.config.JavaScriptListener[67] - failed invoking script script/logback.js
java.lang.NullPointerException: Cannot invoke "javax.script.ScriptEngine.put(String, Object)" because "engine" is null
----

è¿™æ˜¯å› ä¸º https://openjdk.org/jeps/372[JEP 372: Remove the Nashorn JavaScript Engine^] ææ¡ˆï¼Œä» OpenJDK 11 å¼€å§‹ï¼Œå°† Nashorn JavaScript Engine ç§»é™¤äº†ã€‚ç”±äºç›¸å…³åŠŸèƒ½ä½¿ç”¨äº† JavaScript å¼•æ“ï¼Œæ‰€ä»¥ï¼Œå°±æŠ¥äº† â€œCannot invoke "javax.script.ScriptEngine.put(String, Object)" because "engine" is nullâ€ é”™è¯¯ã€‚å¤„ç†åŠæ³•å¦‚ä¸Šï¼ŒåŠ å›ç›¸å…³çš„ä¾èµ–ï¼š

[source%nowrap,xml,{source_attr}]
----
<dependency>
    <groupId>org.openjdk.nashorn</groupId>
    <artifactId>nashorn-core</artifactId>
    <version>15.4</version>
</dependency>
----

=== Java Validation API

åœ¨æœ€è¿‘ä¸€ä¸ªé¡¹ç›®å‡çº§

[source%nowrap,{source_attr}]
----
Caused by: java.lang.ExceptionInInitializerError: Exception javax.validation.ValidationException: HV000183: Unable to initialize 'javax.el.ExpressionFactory'. Check that you have the EL dependencies on the classpath, or use ParameterMessageInterpolator instead [in thread "BZ-22001-108-T-17"]
    at org.hibernate.validator.messageinterpolation.ResourceBundleMessageInterpolator.buildExpressionFactory(ResourceBundleMessageInterpolator.java:199)
    at org.hibernate.validator.messageinterpolation.ResourceBundleMessageInterpolator.<init>(ResourceBundleMessageInterpolator.java:94)
    at org.hibernate.validator.internal.engine.AbstractConfigurationImpl.getDefaultMessageInterpolator(AbstractConfigurationImpl.java:570)
    at org.hibernate.validator.internal.engine.AbstractConfigurationImpl.getDefaultMessageInterpolatorConfiguredWithClassLoader(AbstractConfigurationImpl.java:790)
    at org.hibernate.validator.internal.engine.AbstractConfigurationImpl.getMessageInterpolator(AbstractConfigurationImpl.java:480)
    at org.hibernate.validator.internal.engine.ValidatorFactoryImpl.<init>(ValidatorFactoryImpl.java:151)
    at org.hibernate.validator.HibernateValidator.buildValidatorFactory(HibernateValidator.java:38)
    at org.hibernate.validator.internal.engine.AbstractConfigurationImpl.buildValidatorFactory(AbstractConfigurationImpl.java:430)
----

=== å„ç§åŒ…

[source%nowrap,{source_attr}]
----
Caused by: java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not "opens java.lang" to unnamed module @66f57048
	at java.base/java.lang.reflect.AccessibleObject.throwInaccessibleObjectException(AccessibleObject.java:391)

// --add-opens java.base/java.lang=ALL-UNNAMED
----



[source%nowrap,{source_attr}]
----
Caused by: java.lang.reflect.InaccessibleObjectException: Unable to make field protected int[] java.util.Calendar.fields accessible: module java.base does not "opens java.util" to unnamed module @21282ed8

// --add-opens java.base/java.util=ALL-UNNAMED
----

[source%nowrap,{source_attr}]
----
Caused by: java.lang.IllegalAccessError: class com.jd.org.msgpack.template.TemplateRegistry (in unnamed module @0x21282ed8) cannot access class sun.util.calendar.ZoneInfo (in module java.base) because module java.base does not export sun.util.calendar to unnamed module @0x21282ed8

// --add-opens java.base/sun.util.calendar=ALL-UNNAMED
----

[source%nowrap,{source_attr}]
----
java.lang.reflect.InaccessibleObjectException: Unable to make field final int[] java.math.BigInteger.mag accessible: module java.base does not "opens java.math" to unnamed module @21282ed8

// --add-opens java.base/java.math=ALL-UNNAMED
----

[source%nowrap,{source_attr}]
----
----

== Spring Boot é¡¹ç›®

== Java Web é¡¹ç›®


== å‡çº§ç›¸å…³é—®é¢˜

== æ€§èƒ½å¯¹æ¯”

GC

. JDK8 G1 GC
. JDK17 ZGC
. JDK21 G1 GC
. JDK21 ZGC
. JDK21 Gen ZGC

æŒ‡æ ‡

* [x] å»¶è¿Ÿ
* [ ] ååé‡
* [x] CPU
* [x] GC åœé¡¿

// image::/images/[title="",alt="",{image_attr}]

[source%nowrap,xml,{source_attr}]
----
<profile>
  <id>Java1.8</id>
  <activation>
    <jdk>1.8</jdk>
  </activation>
  <properties>
    <spring.version>5.3.33</spring.version>
  </properties>
  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>3.2.5</version>
        <configuration>
          <includes>
            <include>**/*Test.java</include>
          </includes>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>3.13.0</version>
        <configuration>
          <showWarnings>true</showWarnings>
          <fork>true</fork>
        </configuration>
      </plugin>
    </plugins>
  </build>
</profile>
<profile>
  <id>Java17</id>
  <activation>
    <jdk>[17,)</jdk>
  </activation>
  <properties>
    <spring.version>6.0.19</spring.version>
  </properties>
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>jakarta.servlet</groupId>
        <artifactId>jakarta.servlet-api</artifactId>
        <version>6.0.0</version>
        <scope>provided</scope>
      </dependency>
      <dependency>
        <groupId>org.openjdk.nashorn</groupId>
        <artifactId>nashorn-core</artifactId>
        <version>15.4</version>
      </dependency>
      <dependency>
        <groupId>org.glassfish.jaxb</groupId>
        <artifactId>jaxb-runtime</artifactId>
        <version>2.3.9</version>
      </dependency>
    </dependencies>
  </dependencyManagement>
  <dependencies>
    <dependency>
      <groupId>javax.annotation</groupId>
      <artifactId>javax.annotation-api</artifactId>
      <version>1.3.2</version>
    </dependency>
  </dependencies>
  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>3.2.5</version>
        <configuration>
          <includes>
            <include>**/*Test.java</include>
          </includes>
          <argLine>
            --add-opens java.base/java.math=ALL-UNNAMED
            --add-opens java.base/sun.util.calendar=ALL-UNNAMED
          </argLine>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>3.13.0</version>
        <configuration>
          <showWarnings>true</showWarnings>
          <fork>true</fork>
          <compilerArgs>
            <arg>-J--add-opens=java.base/java.math=ALL-UNNAMED</arg>
            <arg>-J--add-opens=java.base/sun.util.calendar=ALL-UNNAMED</arg>
          </compilerArgs>
        </configuration>
      </plugin>
    </plugins>
  </build>
</profile>
----

. https://hibernate.org/validator/releases/7.0/[Hibernate Validator 7.0^]

