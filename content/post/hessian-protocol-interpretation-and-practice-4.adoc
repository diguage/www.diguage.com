---
title: "Hessian åè®®è§£é‡Šä¸å®æˆ˜ï¼ˆå››ï¼‰ï¼šæ•°ç»„ä¸é›†åˆ"
date: 2022-05-26T18:01:43+08:00
draft: false
keywords: ["Hessian","åºåˆ—åŒ–","åè®®","Java","å¾®æœåŠ¡","æ¶æ„","ç¨‹åºè®¾è®¡"]
tags: ["Java","å¾®æœåŠ¡","æ¶æ„","è®¾è®¡","åºåˆ—åŒ–"]
categories: ["ç³»ç»Ÿæ¶æ„","ç¨‹åºè®¾è®¡"]
thumbnail: "images/common/confused-target-vector.jpg"

weight: 1
---


å‰æ®µæ—¶é—´ï¼Œç¿»è¯‘äº† Hessian 2.0 çš„åºåˆ—åŒ–åè®®ï¼Œå‘å¸ƒåœ¨äº† https://www.diguage.com/post/hessian-serialization-protocol/[Hessian 2.0 åºåˆ—åŒ–åè®®ï¼ˆä¸­æ–‡ç‰ˆï¼‰^]ã€‚ä½†æ˜¯ï¼Œå…¶ä¸­æœ‰å¾ˆå¤šè¨€è¯­ä¸è¯¦ä¹‹å¤„ã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥ä¼šç”¨å‡ ç¯‡æ–‡ç« æ¥è¯¦ç»†è§£é‡Šå¹¶å®è·µä¸€ä¸‹ Hessian åºåˆ—åŒ–åè®®ï¼Œä»¥æ±‚åšåˆ°çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚ç›®å½•å¦‚ä¸‹ï¼š

. https://www.diguage.com/post/hessian-protocol-interpretation-and-practice-1/[Hessian åè®®è§£é‡Šä¸å®æˆ˜ï¼ˆä¸€ï¼‰ï¼šå¸ƒå°”ã€æ—¥æœŸã€æµ®ç‚¹æ•°ä¸æ•´æ•°^] -- ä»‹ç»å¸ƒå°”å‹æ•°æ®ã€æ—¥æœŸç±»å‹ã€æµ®ç‚¹ç±»å‹æ•°æ®å’Œæ•´æ•°ç±»å‹æ•°æ®ç­‰å››ç§ç±»å‹çš„æ•°æ®çš„å¤„ç†ã€‚
. https://www.diguage.com/post/hessian-protocol-interpretation-and-practice-2/[Hessian åè®®è§£é‡Šä¸å®æˆ˜ï¼ˆäºŒï¼‰ï¼šé•¿æ•´å‹ã€äºŒè¿›åˆ¶æ•°æ®ä¸ Null^] -- ä»‹ç»é•¿æ•´æ•°ç±»å‹æ•°æ®ã€äºŒè¿›åˆ¶æ•°æ®å’Œ `null` ç­‰ä¸‰ç§ç±»å‹çš„æ•°æ®çš„å¤„ç†ã€‚
. https://www.diguage.com/post/hessian-protocol-interpretation-and-practice-3/[Hessian åè®®è§£é‡Šä¸å®æˆ˜ï¼ˆä¸‰ï¼‰ï¼šå­—ç¬¦ä¸²^] -- ä¸“é—¨ä»‹ç»äº†å…³äºå­—ç¬¦ä¸²çš„å¤„ç†ã€‚ç”±äºå­—ç¬¦ä¸²éœ€è¦é“ºå«çš„åŸºç¡€çŸ¥è¯†æ¯”è¾ƒå¤šï¼Œå¤„ç†ç»†èŠ‚ä¹Ÿæœ‰ç¹çï¼Œæ‰€ä»¥å•ç‹¬æˆç¯‡æ¥ä»‹ç»ã€‚
. https://www.diguage.com/post/hessian-source-analysis-for-java/[Hessian æºç åˆ†æï¼ˆJavaï¼‰^] -- å¼€å§‹ç¬¬å››ç¯‡åˆ†æä¹‹å‰ï¼Œå…ˆæ¥ä»‹ç»ä¸€ä¸‹ Hessian çš„æºç å®ç°ã€‚æ–¹ä¾¿åç»­å±•å¼€è¯´æ˜ã€‚
. https://www.diguage.com/post/hessian-protocol-interpretation-and-practice-4/[Hessian åè®®è§£é‡Šä¸å®æˆ˜ï¼ˆå››ï¼‰ï¼šæ•°ç»„ä¸é›†åˆ^] -- é“ºå«äº†ä¸€äº›å…³äºå®ä¾‹å¯¹è±¡çš„å¤„ç†ï¼Œé‡ç‚¹ä»‹ç»å…³äºæ•°ç»„å’Œé›†åˆçš„ç›¸å…³å¤„ç†ã€‚
. https://www.diguage.com/post/hessian-protocol-interpretation-and-practice-5/[Hessian åè®®è§£é‡Šä¸å®æˆ˜ï¼ˆäº”ï¼‰ï¼šå¯¹è±¡ä¸æ˜ å°„^] -- é‡ç‚¹ä»‹ç»å…³äºå¯¹è±¡ä¸æ˜ å°„çš„ç›¸å…³å¤„ç†ã€‚
. æœªå®Œå¾…ç»­ï¼Œæ•¬è¯·ç»§ç»­å…³æ³¨ https://www.diguage.com/["åœ°ç“œå“¥"åšå®¢ç½‘^]ã€‚

åœ¨ä¸Šä¸€ç¯‡æ–‡ç«  https://www.diguage.com/post/hessian-source-analysis-for-java/[Hessian æºç åˆ†æï¼ˆJavaï¼‰^] å¯¹ Hessian çš„ Java å®ç°åšäº†ä¸€ä¸ªæ¦‚è¦çš„åˆ†æï¼Œå¯¹å¤„ç†æµç¨‹ä»¥åŠæ•´ä½“æ¶æ„åšäº†ä¸€ä¸ªç®€å•çš„åˆ†æã€‚æ¥ä¸‹æ¥ï¼Œå›åˆ°ä¸»é¢˜ï¼Œç»§ç»­æ¥è§£é‡Š Hessian åºåˆ—åŒ–åè®®ã€‚è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬æ¥é‡ç‚¹åˆ†æä¸€ä¸‹æ•°ç»„ä¸é›†åˆç›¸å…³çš„æ“ä½œã€‚

== åŸºç¡€å·¥å…·æ–¹æ³•

åŸºç¡€å·¥å…·æ–¹æ³•å°±ä¸å†èµ˜è¿°ï¼Œè¯·ç›´æ¥å‚è€ƒ https://www.diguage.com/post/hessian-protocol-interpretation-and-practice-1/#helper-methods[Hessian åè®®è§£é‡Šä¸å®æˆ˜ï¼ˆä¸€ï¼‰ï¼šåŸºç¡€å·¥å…·æ–¹æ³•^] ä¸­æåˆ°çš„å‡ ä¸ªæ–¹æ³•ã€‚

å¯¹æ‰“å°å­—ç¬¦çš„å·¥å…·åšä¸€ä¸‹æ”¹é€ ï¼š

[source%nowrap,java,{source_attr}]
----
/**
 * æ‰“å°å­—èŠ‚æ•°ç»„
 *
 * @author Dç“œå“¥ Â· https://www.diguage.com/
 */
private void printBytes(byte[] result) {
    if (Objects.isNull(result)) {
        System.out.println(".... bytes is null ....");
        return;
    }
    int chunk = 0x8000;
    int byteChunk = 8 * 1024;
    if (0 < result.length && chunk < result.length & result[0] == 'R') {
        for (int i = 0; i < result.length; i += (chunk + 3)) {
            int min = Math.max(i - 1, 0);
            int max = Math.min(i + 4, result.length);
            System.out.println(".... " + min + " ~ " + max + " ....");
            for (; min < max; min++) {
                printByte(result[min]);
            }
        }
        System.out.println("...... " + result.length);
    } else if (0 < result.length && byteChunk < result.length 
               && result[0] == 'A') {
        for (int i = 0; i < result.length; i += byteChunk) {
            int min = Math.max(i - 1, 0);
            int max = Math.min(i + 4, result.length);
            System.out.println(".... " + min + " ~ " + max + " ....");
            for (; min < max; min++) {
                printByte(result[min]);
            }
        }
        System.out.println("...... " + result.length);
    } else if (result.length > 0 && (result[0] == 'C' // class def
            // List
            || result[0] == 0x55 || result[0] == 'V'
            || result[0] == 0x57 || result[0] == 0x58
            || (0x70 <= result[0] && result[0] <= ((byte) 0x7F))
            // Map
            || result[0] == 'M' || result[0] == 'H'
            // object
            || result[0] == 'O'
            || (0x60 <= result[0] && result[0] <= ((byte) 0x6F)))) {
        int min = 0;
        int max = result.length;
        System.out.println(".... " + min + " ~ " + max + " ....");
        for (; min < result.length; min++) {
            printByte(result[min]);
        }
    } else {
        int min = 0;
        int max = 10;
        System.out.println(".... " + min + " ~ " + max + " ....");
        for (; min < result.length && min < max; min++) {
            printByte(result[min]);
        }
        if (result.length > max) {
            System.out.println("...... " + result.length);
        }
    }
}

/**
 * æ‰“å°å•ä¸ªå­—èŠ‚
 *
 * @author Dç“œå“¥ Â· https://www.diguage.com/
 */
private void printByte(byte b) {
    String bitx = Integer.toBinaryString(Byte.toUnsignedInt(b));
    String zbits = String.format("%8s", bitx).replace(' ', '0');
    if (0 <= b) {
        System.out.printf("%4d 0x%02X %8s %c %n", b, b, zbits, b);
    } else {
        System.out.printf("%4d 0x%02X %8s %n", b, b, zbits);
    }
}
----

æ— è®ºæ˜¯åºåˆ—åŒ–å®ä¾‹å¯¹è±¡ï¼Œè¿˜æ˜¯åºåˆ—åŒ–é›†åˆç±»ï¼Œå…¶å®éƒ½æ˜¯è°ƒç”¨ `writeObject(Object value)` æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œå°†å…¶åºåˆ—åŒ–è¿‡ç¨‹æå–æˆæ–¹æ³•å¦‚ä¸‹ï¼š

[source%nowrap,java,{source_attr}]
----
/**
 * å¯¹è±¡åºåˆ—åŒ–
 *
 * @author Dç“œå“¥ Â· https://www.diguage.com/
 */
public void objectTo(Object value) throws Throwable {
    ByteArrayOutputStream bos = new ByteArrayOutputStream();
    Hessian2Output out = getHessian2Output(bos);

    out.writeObject(value);
    out.close();
    byte[] result = bos.toByteArray();

    System.out.println("\n== Object: " + value.getClass().getName() + "  ==");
    if (value instanceof Collection<?> && !((Collection<?>) value).isEmpty()) {
        Optional<?> ele = ((Collection<?>) value).stream().findFirst();
        System.out.println("== Generic: " + ele.get().getClass().getName() + "  ==");
    }
    if (value instanceof Map && !((Map) value).isEmpty()) {
        Optional<? extends Map.Entry<?, ?>> optional =
                ((Map<?, ?>) value).entrySet().stream().findFirst();
        Map.Entry<?, ?> entry = optional.get();
        Object key = entry.getKey();
        Object val = entry.getValue();
        System.out.println("== Key Object: " + key.getClass().getName() + "  ==");
        System.out.println("== Val Object: " + val.getClass().getName() + "  ==");
    }
    System.out.println(toJson(value));
    System.out.println("== byte array: hessian result ==");
    printBytes(result);
}

/**
 * æ‰“å°å•ä¸ªå­—èŠ‚
 *
 * @author Dç“œå“¥ Â· https://www.diguage.com/
 */
private String toJson(Object value) {
    // éœ€è¦æ·»åŠ  com.fasterxml.jackson.core:jackson-databind ä¾èµ–
    ObjectMapper mapper = new ObjectMapper();
    // åºåˆ—åŒ–å­—æ®µ
    mapper.setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY);
    try {
        return mapper.writeValueAsString(value);
    } catch (JsonProcessingException e) {
        e.printStackTrace();
        return null;
    }
}
----


[#object]
== é¦–è°ˆå®ä¾‹å¯¹è±¡

è¦é›†åˆå’Œå“ˆå¸Œï¼Œå°±å¿…é¡»å…ˆäº†è§£ä¸€ä¸‹ Hessian å¯¹å®ä¾‹å¯¹è±¡çš„å¤„ç†ã€‚ç”±äºï¼Œå®ä¾‹å¯¹è±¡å’Œå“ˆå¸Œçš„å¤„ç†æœ‰äº›ç›¸ä¼¼ã€‚æ‰€ä»¥ï¼Œæƒ³æŠŠä¸¤ä¸ªæ”¾åœ¨ä¸€èµ·æ¥è¯´æ˜ã€‚è¿™é‡Œå¯¹å®ä¾‹å¯¹è±¡çš„å¤„ç†å…ˆåšä¸ªæ¦‚è¦ä»‹ç»ã€‚

å…ˆçœ‹ä¸€ä¸‹ç±»å®šä¹‰ï¼š

[source%nowrap,java,{source_attr}]
----
package com.diguage;

/**
 * @author Dç“œå“¥ Â· https://www.diguage.com/
 */
public class Car {
    private String name;
    private int age;

    public Car() {
    }

    public Car(String name, int age) {
        this.name = name;
        this.age = age;
    }

    @Override
    public String toString() {
        return "Car{" +
                "name='" + name + '\'' +
                ", age=" + age +
                '}';
    }
}
----

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹åºåˆ—åŒ–æ“ä½œï¼š

[source%nowrap,java,{source_attr}]
----
/**
 * å¯¹è±¡åºåˆ—åŒ–
 *
 * @author Dç“œå“¥ Â· https://www.diguage.com/
 */
@Test
public void testObject1() throws Throwable {
    Car value = new Car("diguage", 47);

    ByteArrayOutputStream bos = new ByteArrayOutputStream();
    Hessian2Output out = getHessian2Output(bos);

    // åœ¨åºåˆ—åŒ–å®ä¾‹å¯¹è±¡æ—¶ï¼Œ
    // é¦–å…ˆï¼Œåºåˆ—åŒ–å®ä¾‹å¯¹è±¡å¯¹åº”çš„ç±»å®šä¹‰ï¼š
    // â‘ ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰â‘¡å­—æ®µæ•°é‡â‘¢å„ä¸ªå±æ€§åç§°
    // å…¶æ¬¡ï¼Œåºåˆ—åŒ–å®ä¾‹å¯¹è±¡
    // â‘ æ ¹æ®ç±»å‹æ‰¾åˆ°å¯¹åº”çš„ç±»å‹ç¼–å·â‘¡ä¾æ¬¡åºåˆ—åŒ–å®ä¾‹å±æ€§
    // å…³äºç¼–å·ç¼–ç ï¼š
    // 1ã€åœ¨ ref âˆˆ [0, 15] æ—¶ï¼Œç¼–ç ä¸ºï¼šBC_OBJECT_DIRECTï¼ˆ0x60ï¼‰+ ref
    // 2ã€åœ¨ ref âˆˆ [16, ] æ—¶ï¼Œç¼–ç ä¸º â‘ O â‘¡refï¼ˆä»¥intç¼–ç ï¼‰
    // ç±»å‹ç¼–å·æ²¡æœ‰å‰ç½®å­˜å‚¨ï¼Œæ˜¯æ ¹æ®ç±»å‹åœ¨åºåˆ—åŒ–å‡ºç°é¡ºåºæ¥ç¼–å·ï¼Œä» 0 å¼€å§‹ï¼Œä¾æ¬¡é€’å¢ã€‚
    out.writeObject(value);
    // åºåˆ—åŒ–ä¸¤æ¬¡ï¼ŒæŸ¥çœ‹å·®å¼‚
    // æ ¹æ®å®éªŒå‘ç°ï¼šé‡å¤å¯¹è±¡ä¼šä½¿ç”¨å‰ç½®æ ‡å¿—ä½ 0x51ï¼ˆQï¼‰+ ç¼–å·æ¥å¤„ç†ï¼Œå‡å°‘æ•°æ®é‡ã€‚
    // å¼•ç”¨ç¼–å·æ²¡æœ‰å‰ç½®å­˜å‚¨ï¼Œæ˜¯æ ¹æ®å®ä¾‹åœ¨åºåˆ—åŒ–å‡ºç°çš„é¡ºåºæ¥ç¼–å·ï¼Œä» 0 å¼€å§‹ï¼Œä¾æ¬¡é€’å¢ã€‚
    out.writeObject(value);
    out.close();
    byte[] result = bos.toByteArray();
    String className = value.getClass().getName();
    System.out.println("\n== Object: " + className + "  ==");
    System.out.println(toJson(value));
    System.out.println("== byte array: hessian result ==");
    printBytes(result);
}


// -- è¾“å‡ºç»“æœ ------------------------------------------------
== Object: com.diguage.Car  ==
{"name":"diguage","age":47}
== byte array: hessian result ==
.... 0 ~ 39 ....
  67 0x43 01000011 C 
  15 0x0F 00001111  
  99 0x63 01100011 c 
 111 0x6F 01101111 o 
 109 0x6D 01101101 m 
  46 0x2E 00101110 . 
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  46 0x2E 00101110 . 
  67 0x43 01000011 C 
  97 0x61 01100001 a 
 114 0x72 01110010 r 
-110 0x92 10010010 
   4 0x04 00000100  
 110 0x6E 01101110 n 
  97 0x61 01100001 a 
 109 0x6D 01101101 m 
 101 0x65 01100101 e 
   3 0x03 00000011  
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  96 0x60 01100000 ` 
   7 0x07 00000111  
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
 -65 0xBF 10111111 
  81 0x51 01010001 Q 
-112 0x90 10010000
----

ç»“åˆ https://www.diguage.com/post/hessian-serialization-protocol/#object[Hessian 2.0 åºåˆ—åŒ–åè®®ï¼ˆä¸­æ–‡ç‰ˆï¼‰ï¼šå¯¹è±¡^] ä¸­çš„è§„å®šæ¥çœ‹ï¼Œè¿™ä¸ªå®éªŒéªŒè¯å¦‚ä¸‹è§„åˆ™ï¼š

åœ¨åºåˆ—åŒ–å®ä¾‹å¯¹è±¡æ—¶ï¼Œ

. é¦–å…ˆï¼Œåºåˆ—åŒ–å®ä¾‹å¯¹è±¡å¯¹åº”çš„ç±»å®šä¹‰ã€‚æŒ‰ç…§å¦‚ä¸‹å±æ€§ï¼Œåºåˆ—åŒ–å¦‚ä¸‹ä¿¡æ¯ï¼š
.. ç±»å‹æ ‡å¿—ä½ `0x43`ï¼ˆ`C`ï¼‰
.. ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
.. å­—æ®µæ•°é‡
.. å„ä¸ªå±æ€§åç§°
. å…¶æ¬¡ï¼Œåºåˆ—åŒ–å®ä¾‹å¯¹è±¡
.. æ ¹æ®ç±»å‹å‡ºç°çš„é¡ºåºï¼Œæ‰¾åˆ°å¯¹åº”çš„ç±»å‹ç¼–å·ï¼ˆä» `0` å¼€å§‹ï¼‰
.. ä¾æ¬¡åºåˆ—åŒ–å®ä¾‹å±æ€§

å…³äºç±»å‹ç¼–å·ç¼–ç éœ€è¦ç‰¹åˆ«è¯´æ˜ä¸€ä¸‹ï¼š

. åœ¨ `ref âˆˆ [0, 15]` æ—¶ï¼Œç¼–ç ä¸ºï¼š `0x60`ï¼ˆ```ï¼‰+ `ref`
. åœ¨ `ref âˆˆ [16, ]` æ—¶ï¼Œç¼–ç æ ¼å¼ä¸ºï¼š
.. `O`
.. `ref`ï¼ˆä»¥ `int` ç¼–ç ï¼‰

ç±»å‹ç¼–å·æ²¡æœ‰å‰ç½®å­˜å‚¨ï¼Œæ˜¯æ ¹æ®ç±»å‹åœ¨åºåˆ—åŒ–æ—¶å‡ºç°çš„é¡ºåºæ¥ç¼–å·ï¼Œä» `0` å¼€å§‹ï¼Œä¾æ¬¡é€’å¢ã€‚

æ ¹æ®å®éªŒå‘ç°ï¼šé‡å¤å¯¹è±¡ä¼šä½¿ç”¨å‰ç½®æ ‡å¿—ä½ `0x51`ï¼ˆ`Q`ï¼‰+ ç¼–å·æ¥å¤„ç†ï¼Œè¿™æ ·å¯ä»¥å‡å°‘é‡å¤æ•°æ®çš„é‡å¤ç¼–ç ï¼Œå‡å°‘åºåˆ—åŒ–åçš„å­—èŠ‚é•¿åº¦ã€‚å¦å¤–ï¼Œå¼•ç”¨ç¼–å·æ²¡æœ‰å‰ç½®å­˜å‚¨ï¼Œæ˜¯æ ¹æ®å®ä¾‹åœ¨åºåˆ—åŒ–æ—¶å‡ºç°çš„é¡ºåºæ¥ç¼–å·ï¼Œä» `0` å¼€å§‹ï¼Œä¾æ¬¡é€’å¢ã€‚

.å¦‚ä½•å®šä½å¯¹è±¡ï¼Ÿ
****
çœ‹åºåˆ—åŒ–ç»“æœï¼Œåœ¨æ ‡å¿—ä½ `0x51`ï¼ˆ`Q`ï¼‰åé¢ï¼Œå†™å…¥çš„æ˜¯ä¸€ä¸ªæ•°å­—ã€‚ä½†æ˜¯ï¼Œå‰é¢å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–æ—¶ï¼Œä¹Ÿæ²¡æœ‰å†™æ•°å­—ã€‚æˆ‘çŒœæµ‹æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ï¼Œä¼šæ ¹æ®å­—èŠ‚æ•°ç»„é‡æ–°æ„å»ºèµ·æ¥å¯¹è±¡å’Œæ•°å­—çš„å¯¹åº”å…³ç³»ã€‚
****

å…³äºå®ä¾‹å¯¹è±¡çš„åºåˆ—åŒ–æ“ä½œï¼Œè¿™äº›ä¿¡æ¯å·²ç»è¶³å¤Ÿæˆ‘ä»¬å±•å¼€ä¸‹æ–‡ã€‚å…¶ä»–ä¿¡æ¯ï¼Œåç»­å†å±•å¼€è®¨è®ºã€‚

[#list]
== é“¾è¡¨æ•°æ®

åœ¨ https://www.diguage.com/post/hessian-source-analysis-for-java/[Hessian æºç åˆ†æï¼ˆJavaï¼‰^] ä¸­ï¼Œä»‹ç»äº†ä¸€äº› Hessian çš„æ¶æ„ä»¥åŠåºåˆ—åŒ–çš„æµç¨‹ã€‚å†ç»“åˆä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œæ¶‰åŠé“¾è¡¨å¤„ç†çš„ `Serializer` æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š

. `ArraySerializer`
. `BasicSerializer` --  å…«ç§ç±»å‹æ•°ç»„ã€ `String` æ•°ç»„ã€ `Object` æ•°ç»„éƒ½æ˜¯ç”±å®ƒæ¥è¿›è¡Œå¤„ç†ã€‚
. `CollectionSerializer`
. `EnumerationSerializer`
. `IteratorSerializer`

æŸ¥çœ‹ç›¸å…³ä»£ç ï¼Œå¯¹äºé›†åˆçš„å¤„ç†ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ä¸‰æ­¥èµ°ï¼š

. `AbstractHessianOutput.writeListBegin(int length, String type)`
. `AbstractHessianOutput.writeObject/Int/Double/XXX(Object object)`
. `AbstractHessianOutput.writeListEnd()` -- ä¸ä¸€å®šè°ƒç”¨ã€‚æ˜¯å¦è°ƒç”¨ï¼Œè§†æƒ…å†µè€Œå®šã€‚

å¦å¤–ï¼Œåœ¨ https://www.diguage.com/post/hessian-source-analysis-for-java/[Hessian æºç åˆ†æï¼ˆJavaï¼‰^] ä¸­ï¼Œä¹Ÿæåˆ°åœ¨ `Hessian2Output` ä¸­å®ç°äº† `AbstractHessianOutput` çš„æ¥å£ã€‚æ‰€ä»¥ï¼Œåªéœ€è¦å…³æ³¨ `Hessian2Output` å¯¹ä¸Šè¿°ä¸‰ä¸ªæ–¹æ³•çš„å®ç°å³å¯ã€‚

æ ¹æ®ä»¥ä¸Šåˆ†æï¼Œè®¾è®¡å¦‚ä¸‹å‡ ç§å®éªŒï¼š

. åºåˆ—åŒ– `int[]` ä»¥æµ‹è¯• `BasicSerializer` çš„è¡¨ç°ï¼›
. åºåˆ—åŒ– `Car[]` ä»¥æµ‹è¯• `ArraySerializer` çš„è¡¨ç°ï¼›
. åºåˆ—åŒ– `ArrayList<Integer>`ã€ `LinkedList<Integer>` å’Œ `HashSet<Integer>` ä»¥æµ‹è¯• `CollectionSerializer` çš„è¡¨ç°ï¼›
. åºåˆ—åŒ– `Collection<Integer>.iterator` ä»¥æµ‹è¯• `IteratorSerializer`ã€‚

NOTE: å¯¹æ¯”äº† `IteratorSerializer` å’Œ `EnumerationSerializer` çš„ä»£ç ï¼Œä¸¤è€…å‡ ä¹ä¸€æ¨¡ä¸€æ ·ã€‚å°±ä¸å†é‡å¤æµ‹è¯•äº†ã€‚

[#int-array]
=== `int[]` ğŸ‘‰ `BasicSerializer`

é¦–å…ˆï¼Œä½¿ç”¨ `int[]` æ¥æµ‹è¯•ä¸€ä¸‹ `BasicSerializer` çš„å¤„ç†æƒ…å†µã€‚

[source%nowrap,java,{source_attr}]
----
/**
 * æ•°ç»„åºåˆ—åŒ–
 *
 * @author Dç“œå“¥ Â· https://www.diguage.com/
 */
@Test
public void testIntArray() throws Throwable {
    // åœ¨å¤„ç†é•¿åº¦ä¸º [0, 7] çš„æ•°ç»„æ—¶ï¼Œ
    // â‘ å‰ç½®æ ‡å¿—ä½ï¼š BC_LIST_DIRECTï¼ˆ0x70ï¼‰+ length
    //   èŒƒå›´ï¼š0x70(p) ~ 0x77(w)
    // â‘¡ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
    // â‘¢é€ä¸ªæ•°ç»„å…ƒç´ 
    // æ³¨æ„ï¼šå¦‚æœæ•°ç»„ä¸ºç©ºï¼Œåˆ™æ²¡æœ‰ç¬¬â‘¢é¡¹
    objectTo(new int[]{});
    objectTo(new int[]{0});
    objectTo(new int[]{0, 1, 2, 3, 4, 5, 6});
    // åœ¨å¤„ç†é•¿åº¦ä¸º [8, 0] çš„æ•°ç»„æ—¶ï¼Œ
    // â‘ ä½¿ç”¨å‰ç½®æ ‡å¿—ä½ V è¡¨ç¤º
    // â‘¡ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
    // â‘¢æ•°ç»„é•¿åº¦length
    // â‘£é€ä¸ªæ•°ç»„å…ƒç´ 
    objectTo(new int[]{0, 1, 2, 3, 4, 5, 6, 7});
}


// -- è¾“å‡ºç»“æœ ------------------------------------------------
== Object: [I  ==
[]
== byte array: hessian result ==
.... 0 ~ 6 ....
 112 0x70 01110000 p 
   4 0x04 00000100  
  91 0x5B 01011011 [ 
 105 0x69 01101001 i 
 110 0x6E 01101110 n 
 116 0x74 01110100 t 

== Object: [I  ==
[0]
== byte array: hessian result ==
.... 0 ~ 7 ....
 113 0x71 01110001 q 
   4 0x04 00000100  
  91 0x5B 01011011 [ 
 105 0x69 01101001 i 
 110 0x6E 01101110 n 
 116 0x74 01110100 t 
-112 0x90 10010000 

== Object: [I  ==
[0,1,2,3,4,5,6]
== byte array: hessian result ==
.... 0 ~ 13 ....
 119 0x77 01110111 w 
   4 0x04 00000100  
  91 0x5B 01011011 [ 
 105 0x69 01101001 i 
 110 0x6E 01101110 n 
 116 0x74 01110100 t 
-112 0x90 10010000 
-111 0x91 10010001 
-110 0x92 10010010 
-109 0x93 10010011 
-108 0x94 10010100 
-107 0x95 10010101 
-106 0x96 10010110 

== Object: [I  ==
[0,1,2,3,4,5,6,7]
== byte array: hessian result ==
.... 0 ~ 15 ....
  86 0x56 01010110 V 
   4 0x04 00000100  
  91 0x5B 01011011 [ 
 105 0x69 01101001 i 
 110 0x6E 01101110 n 
 116 0x74 01110100 t 
-104 0x98 10011000 
-112 0x90 10010000 
-111 0x91 10010001 
-110 0x92 10010010 
-109 0x93 10010011 
-108 0x94 10010100 
-107 0x95 10010101 
-106 0x96 10010110 
-105 0x97 10010111
----

ç»“åˆ https://www.diguage.com/post/hessian-serialization-protocol/#list[Hessian 2.0 åºåˆ—åŒ–åè®®ï¼ˆä¸­æ–‡ç‰ˆï¼‰ï¼šé“¾è¡¨æ•°æ®^] ä¸­çš„è§„å®šæ¥çœ‹ï¼Œè¿™ä¸ªå®éªŒéªŒè¯äº†ä¸¤æ¡è§„åˆ™ï¼š

. åœ¨å¤„ç†é•¿åº¦ä¸º `[0, 7]` çš„æ•°ç»„æ—¶ï¼Œå¤„ç†æµç¨‹å¦‚ä¸‹ï¼š
.. å‰ç½®æ ‡å¿—ä½ï¼š `0x70`(`p`)+ lengthã€‚æ ‡å¿—ä½èŒƒå›´ï¼š`0x70`(`p`) ~ `0x77`(`w`)
.. ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
.. é€ä¸ªæ•°ç»„å…ƒç´ 
+
--
NOTE: å¦‚æœæ•°ç»„ä¸ºç©ºï¼Œåˆ™æ²¡æœ‰ç¬¬â‘¢é¡¹ã€‚
--
. åœ¨å¤„ç†é•¿åº¦ä¸º `[8, ]` çš„æ•°ç»„æ—¶ï¼Œ
.. ä½¿ç”¨å‰ç½®æ ‡å¿—ä½ `0x56`ï¼ˆ`V`) è¡¨ç¤º
.. ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
.. æ•°ç»„é•¿åº¦ length
.. é€ä¸ªæ•°ç»„å…ƒç´ 


=== `Car[]` ğŸ‘‰ `ArraySerializer`

æ¥ç€ï¼Œä½¿ç”¨ `Car[]` æ¥æµ‹è¯•ä¸€ä¸‹ `ArraySerializer` çš„å¤„ç†æƒ…å†µã€‚

[source%nowrap,java,{source_attr}]
----
/**
 * æµ‹è¯•å¯¹è±¡æ•°ç»„çš„åºåˆ—åŒ–
 *
 * @author Dç“œå“¥ Â· https://www.diguage.com/
 */
@Test
public void testObjectArray() throws Throwable {
    // åœ¨å¤„ç†é•¿åº¦ä¸º [0, 7] çš„æ•°ç»„æ—¶ï¼š
    // â‘ å‰ç½®æ ‡å¿—ä½ï¼š BC_LIST_DIRECTï¼ˆ0x70ï¼‰+ length
    //   èŒƒå›´ï¼š0x70(p) ~ 0x77(w)
    // â‘¡ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
    // â‘¢é€ä¸ªæ•°ç»„å…ƒç´ 
    // æ³¨æ„ï¼šå¦‚æœæ•°ç»„ä¸ºç©ºï¼Œåˆ™æ²¡æœ‰ç¬¬â‘¢é¡¹
    Car c = new Car("diguage", 47);
    objectTo(new Car[]{});
    objectTo(new Car[]{c});
    objectTo(new Car[]{c, c, c, c, c, c, c});
    // åœ¨å¤„ç†é•¿åº¦ä¸º [8, 0] çš„æ•°ç»„æ—¶ï¼š
    // â‘ ä½¿ç”¨å‰ç½®æ ‡å¿—ä½ V è¡¨ç¤º
    // â‘¡ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
    // â‘¢é•¿åº¦length
    // â‘£é€ä¸ªæ•°ç»„å…ƒç´ 
    // ç”±äºæˆ‘è¿™é‡Œä½¿ç”¨äº†ç›¸åŒçš„å…ƒç´ ï¼Œæ‰€ä»¥ï¼Œ
    // é™¤ç¬¬ä¸€ä¸ªå…ƒç´ å¤–ï¼Œå…¶ä»–å…ƒç´ éƒ½è¯•ç”¨å¼•ç”¨ç¼–å·æ¥ç¼–ç ã€‚
    objectTo(new Car[]{c, c, c, c, c, c, c, c});
}


// -- è¾“å‡ºç»“æœ ------------------------------------------------

== Object: [Lcom.diguage.Car;  ==
[]
== byte array: hessian result ==
.... 0 ~ 18 ....
 112 0x70 01110000 p 
  16 0x10 00010000  
  91 0x5B 01011011 [ 
  99 0x63 01100011 c 
 111 0x6F 01101111 o 
 109 0x6D 01101101 m 
  46 0x2E 00101110 . 
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  46 0x2E 00101110 . 
  67 0x43 01000011 C 
  97 0x61 01100001 a 
 114 0x72 01110010 r 

== Object: [Lcom.diguage.Car;  ==
[{"name":"diguage","age":47}]
== byte array: hessian result ==
.... 0 ~ 55 ....
 113 0x71 01110001 q 
  16 0x10 00010000  
  91 0x5B 01011011 [ 
  99 0x63 01100011 c 
 111 0x6F 01101111 o 
 109 0x6D 01101101 m 
  46 0x2E 00101110 . 
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  46 0x2E 00101110 . 
  67 0x43 01000011 C 
  97 0x61 01100001 a 
 114 0x72 01110010 r 
  67 0x43 01000011 C 
  15 0x0F 00001111  
  99 0x63 01100011 c 
 111 0x6F 01101111 o 
 109 0x6D 01101101 m 
  46 0x2E 00101110 . 
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  46 0x2E 00101110 . 
  67 0x43 01000011 C 
  97 0x61 01100001 a 
 114 0x72 01110010 r 
-110 0x92 10010010 
   4 0x04 00000100  
 110 0x6E 01101110 n 
  97 0x61 01100001 a 
 109 0x6D 01101101 m 
 101 0x65 01100101 e 
   3 0x03 00000011  
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  96 0x60 01100000 ` 
   7 0x07 00000111  
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
 -65 0xBF 10111111 

== Object: [Lcom.diguage.Car;  ==
[{"name":"diguage","age":47},
 {"name":"diguage","age":47},
 {"name":"diguage","age":47},
 {"name":"diguage","age":47},
 {"name":"diguage","age":47},
 {"name":"diguage","age":47},
 {"name":"diguage","age":47}]
== byte array: hessian result ==
.... 0 ~ 67 ....
 119 0x77 01110111 w 
  16 0x10 00010000  
  91 0x5B 01011011 [ 
  99 0x63 01100011 c 
 111 0x6F 01101111 o 
 109 0x6D 01101101 m 
  46 0x2E 00101110 . 
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  46 0x2E 00101110 . 
  67 0x43 01000011 C 
  97 0x61 01100001 a 
 114 0x72 01110010 r 
  67 0x43 01000011 C 
  15 0x0F 00001111  
  99 0x63 01100011 c 
 111 0x6F 01101111 o 
 109 0x6D 01101101 m 
  46 0x2E 00101110 . 
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  46 0x2E 00101110 . 
  67 0x43 01000011 C 
  97 0x61 01100001 a 
 114 0x72 01110010 r 
-110 0x92 10010010 
   4 0x04 00000100  
 110 0x6E 01101110 n 
  97 0x61 01100001 a 
 109 0x6D 01101101 m 
 101 0x65 01100101 e 
   3 0x03 00000011  
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  96 0x60 01100000 ` 
   7 0x07 00000111  
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
 -65 0xBF 10111111 
  81 0x51 01010001 Q 
-111 0x91 10010001 
  81 0x51 01010001 Q 
-111 0x91 10010001 
  81 0x51 01010001 Q 
-111 0x91 10010001 
  81 0x51 01010001 Q 
-111 0x91 10010001 
  81 0x51 01010001 Q 
-111 0x91 10010001 
  81 0x51 01010001 Q 
-111 0x91 10010001 

== Object: [Lcom.diguage.Car;  ==
[{"name":"diguage","age":47},
 {"name":"diguage","age":47},
 {"name":"diguage","age":47},
 {"name":"diguage","age":47},
 {"name":"diguage","age":47},
 {"name":"diguage","age":47},
 {"name":"diguage","age":47},
 {"name":"diguage","age":47}]
== byte array: hessian result ==
.... 0 ~ 70 ....
  86 0x56 01010110 V 
  16 0x10 00010000  
  91 0x5B 01011011 [ 
  99 0x63 01100011 c 
 111 0x6F 01101111 o 
 109 0x6D 01101101 m 
  46 0x2E 00101110 . 
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  46 0x2E 00101110 . 
  67 0x43 01000011 C 
  97 0x61 01100001 a 
 114 0x72 01110010 r 
-104 0x98 10011000 
  67 0x43 01000011 C 
  15 0x0F 00001111  
  99 0x63 01100011 c 
 111 0x6F 01101111 o 
 109 0x6D 01101101 m 
  46 0x2E 00101110 . 
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  46 0x2E 00101110 . 
  67 0x43 01000011 C 
  97 0x61 01100001 a 
 114 0x72 01110010 r 
-110 0x92 10010010 
   4 0x04 00000100  
 110 0x6E 01101110 n 
  97 0x61 01100001 a 
 109 0x6D 01101101 m 
 101 0x65 01100101 e 
   3 0x03 00000011  
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
  96 0x60 01100000 ` 
   7 0x07 00000111  
 100 0x64 01100100 d 
 105 0x69 01101001 i 
 103 0x67 01100111 g 
 117 0x75 01110101 u 
  97 0x61 01100001 a 
 103 0x67 01100111 g 
 101 0x65 01100101 e 
 -65 0xBF 10111111 
  81 0x51 01010001 Q 
-111 0x91 10010001 
  81 0x51 01010001 Q 
-111 0x91 10010001 
  81 0x51 01010001 Q 
-111 0x91 10010001 
  81 0x51 01010001 Q 
-111 0x91 10010001 
  81 0x51 01010001 Q 
-111 0x91 10010001 
  81 0x51 01010001 Q 
-111 0x91 10010001 
  81 0x51 01010001 Q 
-111 0x91 10010001 
----

å®éªŒç»“æœä¸ <<int-array>> ä¸­ç›¸åŒï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚

ç›¸åŒå®ä¾‹å¯¹è±¡åœ¨å¤šæ¬¡åºåˆ—åŒ–æ—¶ï¼Œåªä¼šåºåˆ—åŒ–ç¬¬ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚åé¢çš„ï¼Œéƒ½æ˜¯å¼•ç”¨æ ‡å¿—ä½ `0x51`ï¼ˆ`Q`ï¼‰ + â€œå¼•ç”¨ç¼–å·â€ï¼Œæ¥æŒ‡å‘ç¬¬ä¸€ä¸ªè¢«åºåˆ—åŒ–çš„å®ä¾‹å¯¹è±¡ã€‚è¿™ä¸€ç‚¹å’Œ <<object-1>> ä¸­çš„æè¿°ä¸€è‡´ã€‚


=== `ArrayList<Integer>` ğŸ‘‰ `CollectionSerializer`

å†æ¥ç€ï¼Œä½¿ç”¨ `ArrayList<Integer>` æ¥æµ‹è¯•ä¸€ä¸‹ `CollectionSerializer` çš„å¤„ç†æƒ…å†µã€‚

[source%nowrap,java,{source_attr}]
----
/**
 * æµ‹è¯• ArrayList çš„åºåˆ—åŒ–
 *
 * @author Dç“œå“¥ Â· https://www.diguage.com/
 */
@Test
public void testIntArrayList() throws Throwable {
    // åœ¨å¤„ç†é•¿åº¦ä¸º [0, 7] çš„ ArrayList æ—¶ï¼š
    // â‘ å‰ç½®æ ‡å¿—ä½ï¼š BC_LIST_DIRECT_UNTYPEDï¼ˆ0x78ï¼‰+ length
    //   èŒƒå›´ï¼š0x78(x) ~ 0x7F
    // â‘¡é€ä¸ªé›†åˆå…ƒç´ 
    // æ³¨æ„ï¼šå¦‚æœé›†åˆä¸ºç©ºï¼Œåˆ™æ²¡æœ‰ç¬¬â‘¡é¡¹
    List<Integer> al0 = new ArrayList<>();
    objectTo(al0);

    List<Integer> ints1 = Arrays.asList(0);
    List<Integer> al1 = new ArrayList<>(ints1);
    objectTo(al1);

    List<Integer> ints7 = Arrays.asList(0, 1, 2, 3, 4, 5, 6);
    List<Integer> al7 = new ArrayList<>(ints7);
    objectTo(al7);

    // åœ¨å¤„ç†é•¿åº¦ä¸º [8, 0] çš„ ArrayList æ—¶ï¼š
    // â‘ ä½¿ç”¨å‰ç½®æ ‡å¿—ä½ 0x58ï¼ˆXï¼‰ è¡¨ç¤º
    // â‘¡é›†åˆé•¿åº¦ length
    // â‘¢é€ä¸ªé›†åˆå…ƒç´ 
    List<Integer> ints8 = Arrays.asList(0, 1, 2, 3, 4, 5, 6, 7);
    List<Integer> al8 = new ArrayList<>(ints8);
    objectTo(al8);
}


// -- è¾“å‡ºç»“æœ ------------------------------------------------
== Object: java.util.ArrayList  ==
[]
== byte array: hessian result ==
.... 0 ~ 1 ....
 120 0x78 01111000 x 

== Object: java.util.ArrayList  ==
== Generic: java.lang.Integer  ==
[0]
== byte array: hessian result ==
.... 0 ~ 2 ....
 121 0x79 01111001 y 
-112 0x90 10010000 

== Object: java.util.ArrayList  ==
== Generic: java.lang.Integer  ==
[0,1,2,3,4,5,6]
== byte array: hessian result ==
.... 0 ~ 8 ....
 127 0x7F 01111111  
-112 0x90 10010000 
-111 0x91 10010001 
-110 0x92 10010010 
-109 0x93 10010011 
-108 0x94 10010100 
-107 0x95 10010101 
-106 0x96 10010110 

== Object: java.util.ArrayList  ==
== Generic: java.lang.Integer  ==
[0,1,2,3,4,5,6,7]
== byte array: hessian result ==
.... 0 ~ 10 ....
  88 0x58 01011000 X 
-104 0x98 10011000 
-112 0x90 10010000 
-111 0x91 10010001 
-110 0x92 10010010 
-109 0x93 10010011 
-108 0x94 10010100 
-107 0x95 10010101 
-106 0x96 10010110 
-105 0x97 10010111 
----

Hessian åœ¨å¤„ç† `ArrayList` å¯¹è±¡æ—¶ï¼Œä¸æ•°ç»„å¤„ç†ç•¥æœ‰ä¸åŒï¼š

. åœ¨å¤„ç†é•¿åº¦ä¸º `[0, 7]` çš„ `ArrayList` æ—¶ï¼š
.. å‰ç½®æ ‡å¿—ä½ï¼š `0x78`(`x`)+ lengthã€‚å‰ç½®æ ‡å¿—ä½çš„èŒƒå›´ï¼š`0x78`(`x`) ~ `0x7F`
.. é€ä¸ªé›†åˆå…ƒç´ 
+
--
æ³¨æ„ï¼šå¦‚æœé›†åˆä¸ºç©ºï¼Œåˆ™æ²¡æœ‰ç¬¬â‘¡é¡¹
--
+
. åœ¨å¤„ç†é•¿åº¦ä¸º `[8, 0]` çš„ `ArrayList` æ—¶ï¼š
.. ä½¿ç”¨å‰ç½®æ ‡å¿—ä½ `0x58`ï¼ˆ`X`ï¼‰ è¡¨ç¤º
.. é›†åˆé•¿åº¦ length
.. é€ä¸ªé›†åˆå…ƒç´ 

Hessian å¯¹ `ArrayList` çš„å¤„ç†æœ‰ä¸€å®šçš„ç…§é¡¾æˆåˆ†ï¼šå®ƒä¸éœ€è¦åºåˆ—åŒ– `ArrayList` çš„ç±»å‹ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‹é¢çš„å¤„ç†å°±çŸ¥é“äº†ã€‚

=== `LinkedList<Integer>` ğŸ‘‰ `CollectionSerializer`

åˆæ¥ç€ï¼Œä½¿ç”¨ `LinkedList<Integer>` æ¥æµ‹è¯•ä¸€ä¸‹ `CollectionSerializer` çš„å¤„ç†æƒ…å†µã€‚

[source%nowrap,java,{source_attr}]
----
/**
 * æµ‹è¯• LinkedList çš„åºåˆ—åŒ–
 *
 * @author Dç“œå“¥ Â· https://www.diguage.com/
 */
@Test
public void testIntLinkedList() throws Throwable {
    // åœ¨å¤„ç†é•¿åº¦ä¸º [0, 7] çš„ LinkedList æ—¶ï¼Œ
    // â‘ å‰ç½®æ ‡å¿—ä½ï¼š BC_LIST_DIRECTï¼ˆ0x70ï¼‰+ length
    //   èŒƒå›´ï¼š0x70(p) ~ 0x77(w)
    // â‘¡ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
    // â‘¢é€ä¸ªæ•°ç»„å…ƒç´ 
    // æ³¨æ„ï¼šå¦‚æœæ•°ç»„ä¸ºç©ºï¼Œåˆ™æ²¡æœ‰ç¬¬â‘¢é¡¹
    List<Integer> al0 = new LinkedList<>();
    objectTo(al0);

    List<Integer> ints1 = Arrays.asList(0);
    List<Integer> al1 = new LinkedList<>(ints1);
    objectTo(al1);

    List<Integer> ints7 = Arrays.asList(0, 1, 2, 3, 4, 5, 6);
    List<Integer> al7 = new LinkedList<>(ints7);
    objectTo(al7);

    // åœ¨å¤„ç†é•¿åº¦ä¸º [8, 0] çš„ LinkedList æ—¶ï¼Œ
    // â‘ ä½¿ç”¨å‰ç½®æ ‡å¿—ä½ V è¡¨ç¤º
    // â‘¡ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
    // â‘¢æ•°ç»„é•¿åº¦length
    // â‘£é€ä¸ªæ•°ç»„å…ƒç´ 
    List<Integer> ints8 = Arrays.asList(0, 1, 2, 3, 4, 5, 6, 7);
    List<Integer> al8 = new LinkedList<>(ints8);
    objectTo(al8);
}


// -- è¾“å‡ºç»“æœ ------------------------------------------------

== Object: java.util.LinkedList  ==
[]
== byte array: hessian result ==
.... 0 ~ 22 ....
 112 0x70 01110000 p 
  20 0x14 00010100  
 106 0x6A 01101010 j 
  97 0x61 01100001 a 
 118 0x76 01110110 v 
  97 0x61 01100001 a 
  46 0x2E 00101110 . 
 117 0x75 01110101 u 
 116 0x74 01110100 t 
 105 0x69 01101001 i 
 108 0x6C 01101100 l 
  46 0x2E 00101110 . 
  76 0x4C 01001100 L 
 105 0x69 01101001 i 
 110 0x6E 01101110 n 
 107 0x6B 01101011 k 
 101 0x65 01100101 e 
 100 0x64 01100100 d 
  76 0x4C 01001100 L 
 105 0x69 01101001 i 
 115 0x73 01110011 s 
 116 0x74 01110100 t 

== Object: java.util.LinkedList  ==
== Generic: java.lang.Integer  ==
[0]
== byte array: hessian result ==
.... 0 ~ 23 ....
 113 0x71 01110001 q 
  20 0x14 00010100  
 106 0x6A 01101010 j 
  97 0x61 01100001 a 
 118 0x76 01110110 v 
  97 0x61 01100001 a 
  46 0x2E 00101110 . 
 117 0x75 01110101 u 
 116 0x74 01110100 t 
 105 0x69 01101001 i 
 108 0x6C 01101100 l 
  46 0x2E 00101110 . 
  76 0x4C 01001100 L 
 105 0x69 01101001 i 
 110 0x6E 01101110 n 
 107 0x6B 01101011 k 
 101 0x65 01100101 e 
 100 0x64 01100100 d 
  76 0x4C 01001100 L 
 105 0x69 01101001 i 
 115 0x73 01110011 s 
 116 0x74 01110100 t 
-112 0x90 10010000 

== Object: java.util.LinkedList  ==
== Generic: java.lang.Integer  ==
[0,1,2,3,4,5,6]
== byte array: hessian result ==
.... 0 ~ 29 ....
 119 0x77 01110111 w 
  20 0x14 00010100  
 106 0x6A 01101010 j 
  97 0x61 01100001 a 
 118 0x76 01110110 v 
  97 0x61 01100001 a 
  46 0x2E 00101110 . 
 117 0x75 01110101 u 
 116 0x74 01110100 t 
 105 0x69 01101001 i 
 108 0x6C 01101100 l 
  46 0x2E 00101110 . 
  76 0x4C 01001100 L 
 105 0x69 01101001 i 
 110 0x6E 01101110 n 
 107 0x6B 01101011 k 
 101 0x65 01100101 e 
 100 0x64 01100100 d 
  76 0x4C 01001100 L 
 105 0x69 01101001 i 
 115 0x73 01110011 s 
 116 0x74 01110100 t 
-112 0x90 10010000 
-111 0x91 10010001 
-110 0x92 10010010 
-109 0x93 10010011 
-108 0x94 10010100 
-107 0x95 10010101 
-106 0x96 10010110 

== Object: java.util.LinkedList  ==
== Generic: java.lang.Integer  ==
[0,1,2,3,4,5,6,7]
== byte array: hessian result ==
.... 0 ~ 31 ....
  86 0x56 01010110 V 
  20 0x14 00010100  
 106 0x6A 01101010 j 
  97 0x61 01100001 a 
 118 0x76 01110110 v 
  97 0x61 01100001 a 
  46 0x2E 00101110 . 
 117 0x75 01110101 u 
 116 0x74 01110100 t 
 105 0x69 01101001 i 
 108 0x6C 01101100 l 
  46 0x2E 00101110 . 
  76 0x4C 01001100 L 
 105 0x69 01101001 i 
 110 0x6E 01101110 n 
 107 0x6B 01101011 k 
 101 0x65 01100101 e 
 100 0x64 01100100 d 
  76 0x4C 01001100 L 
 105 0x69 01101001 i 
 115 0x73 01110011 s 
 116 0x74 01110100 t 
-104 0x98 10011000 
-112 0x90 10010000 
-111 0x91 10010001 
-110 0x92 10010010 
-109 0x93 10010011 
-108 0x94 10010100 
-107 0x95 10010101 
-106 0x96 10010110 
-105 0x97 10010111 
----

å¯¹äº `LinkedList` ä¸ `ArrayList` å·®è·å·¨å¤§ï¼Œåå€’æ˜¯å’Œå‰é¢çš„ <<int-array>> ç›¸åŒã€‚ç›¸æ¯” `ArrayList`ï¼Œå¤„ç† `LinkedList` éœ€è¦å¢åŠ  `LinkedList` çš„ç±»å‹ã€‚æ‰€ä»¥ï¼Œ**å¾®æœåŠ¡çš„å‚æ•°ä¸è¿”å›å€¼ï¼Œå°½é‡é€‰æ‹© `ArrayList` ç±»å‹ã€‚**

ç»è¿‡æµ‹è¯•ï¼Œå…¶ä»– `Collection` çš„å®ç°éƒ½ä¸æ­¤ç›¸åŒï¼Œæ¯”å¦‚ `HashSet`ï¼Œå†æ¯”å¦‚ `Arrays.asList(T... a)`ï¼Œå°±ä¸å†èµ˜è¿°ï¼Œç•™ç»™å¤§å®¶è‡ªå·±åšæµ‹è¯•ã€‚

[#iterator]
=== `Collection<Integer>.iterator` ğŸ‘‰ `IteratorSerializer`

æœ€åï¼Œä½¿ç”¨ `Collection<Integer>.iterator` æ¥æµ‹è¯•ä¸€ä¸‹ `IteratorSerializer` çš„å¤„ç†æƒ…å†µã€‚

[source%nowrap,java,{source_attr}]
----
/**
 * æµ‹è¯• Iterator çš„åºåˆ—åŒ–
 *
 * @author Dç“œå“¥ Â· https://www.diguage.com/
 */
@Test
public void testIntIterator() throws Throwable {
    // å¤„ç† Iterator å’Œ Enumeration æ—¶ï¼Œ
    // â‘ å‰ç½®æ ‡å¿—ä½ BC_LIST_VARIABLE_UNTYPEDï¼ˆ0x57ï¼‰
    // â‘¡éå† Iteratorï¼Œé€ä¸ªå†™å…¥å…ƒç´ ã€‚ä¸ºç©ºåˆ™ä¸å†™å…¥ã€‚
    // â‘¢å†™å…¥ç»“æŸæ ‡å¿—ä½ BC_ENDï¼ˆZï¼‰
    List<Integer> al0 = new ArrayList<>();
    objectTo(al0.iterator());

    List<Integer> ints1 = new ArrayList<>(Arrays.asList(0));
    objectTo(ints1.iterator());

    List<Integer> ints2 = Arrays.asList(0, 1);
    objectTo(ints2.iterator());
}

// -- è¾“å‡ºç»“æœ ------------------------------------------------
== Object: java.util.ArrayList$Itr  ==
[]
== byte array: hessian result ==
.... 0 ~ 2 ....
  87 0x57 01010111 W 
  90 0x5A 01011010 Z 

== Object: java.util.ArrayList$Itr  ==
[]
== byte array: hessian result ==
.... 0 ~ 3 ....
  87 0x57 01010111 W 
-112 0x90 10010000 
  90 0x5A 01011010 Z 

== Object: java.util.AbstractList$Itr  ==
[]
== byte array: hessian result ==
.... 0 ~ 4 ....
  87 0x57 01010111 W 
-112 0x90 10010000 
-111 0x91 10010001 
  90 0x5A 01011010 Z 
----

å¤„ç† `Iterator` å’Œ `Enumeration` æ—¶ï¼š

. é¦–å…ˆï¼Œå†™å…¥å‰ç½®æ ‡å¿—ä½ `0x57`ï¼ˆ`W`ï¼‰
. å…¶æ¬¡ï¼Œéå† `Iterator` æˆ– `Enumeration`ï¼Œé€ä¸ªå†™å…¥å…ƒç´ ã€‚ä¸ºç©ºåˆ™ä¸å†™å…¥ã€‚
. æœ€åï¼Œå†™å…¥ç»“æŸæ ‡å¿—ä½ `0x5A`ï¼ˆ`Z`ï¼‰

è¿™é‡Œæ²¡æœ‰å†™å…¥â€œé•¿åº¦â€ï¼Œæƒ³æƒ³è¿™ä¹Ÿæ­£å¸¸ï¼Œæ¯•ç«Ÿåœ¨ `Iterator` æˆ– `Enumeration` å®ä¾‹ä¸­ï¼Œæ‹¿ä¸åˆ°â€œé•¿åº¦â€å±æ€§ã€‚


=== å°ç»“

ç»“åˆä¸Šé¢çš„æ‰€æœ‰å®éªŒå’Œ https://www.diguage.com/post/hessian-serialization-protocol/#list[Hessian 2.0 åºåˆ—åŒ–åè®®ï¼ˆä¸­æ–‡ç‰ˆï¼‰ï¼šé“¾è¡¨æ•°æ®^] æ¥åšä¸ªæ€»ç»“ï¼š

. åœ¨å¤„ç†æ•°ç»„ä»¥åŠé™¤ `ArrayList` ä»¥å¤–å…¶ä»– `Collection` å®ç°ç±»æ—¶ï¼š
.. åœ¨å¤„ç†é•¿åº¦ä¸º `[0, 7]` çš„æ•°ç»„æ—¶ï¼Œå¤„ç†æµç¨‹å¦‚ä¸‹ï¼š
... å‰ç½®æ ‡å¿—ä½ï¼š `0x70`(`p`)+ lengthã€‚æ ‡å¿—ä½èŒƒå›´ï¼š`0x70`(`p`) ~ `0x77`(`w`)
... ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
... é€ä¸ªæ•°ç»„å…ƒç´ 
.. åœ¨å¤„ç†é•¿åº¦ä¸º `[8, ]` çš„æ•°ç»„æ—¶ï¼Œ
... ä½¿ç”¨å‰ç½®æ ‡å¿—ä½ `0x56`ï¼ˆ`V`) è¡¨ç¤º
... ç±»å‹ï¼ˆå­—ç¬¦ä¸²å½¢å¼ï¼‰
... æ•°ç»„é•¿åº¦ length
... é€ä¸ªæ•°ç»„å…ƒç´ 
. åœ¨å¤„ç† `ArrayList` æ—¶ï¼š
.. åœ¨å¤„ç†é•¿åº¦ä¸º `[0, 7]` çš„ `ArrayList` æ—¶ï¼š
... å‰ç½®æ ‡å¿—ä½ï¼š `0x78`(`x`) + lengthã€‚å‰ç½®æ ‡å¿—ä½çš„èŒƒå›´ï¼š`0x78`(`x`) ~ `0x7F`
... é€ä¸ªé›†åˆå…ƒç´ 
.. åœ¨å¤„ç†é•¿åº¦ä¸º `[8, 0]` çš„ `ArrayList` æ—¶ï¼š
... ä½¿ç”¨å‰ç½®æ ‡å¿—ä½ `0x58`ï¼ˆ`X`ï¼‰ è¡¨ç¤º
... é›†åˆé•¿åº¦ length
... é€ä¸ªé›†åˆå…ƒç´ 
. å¤„ç† `Iterator` å’Œ `Enumeration` æ—¶ï¼š
.. é¦–å…ˆï¼Œå†™å…¥å‰ç½®æ ‡å¿—ä½ `0x57`ï¼ˆ`W`ï¼‰
.. å…¶æ¬¡ï¼Œéå† `Iterator` æˆ– `Enumeration`ï¼Œé€ä¸ªå†™å…¥å…ƒç´ ã€‚ä¸ºç©ºåˆ™ä¸å†™å…¥ã€‚
.. æœ€åï¼Œå†™å…¥ç»“æŸæ ‡å¿—ä½ `0x5A`ï¼ˆ`Z`ï¼‰

å¯¹ç…§åè®®å®šä¹‰ï¼Œä½ ä¼šå‘ç°ï¼Œå…³äº `list ::= x55 type value* 'Z'   # variable-length list` çš„æµ‹è¯•æ²¡æœ‰æ‰¾åˆ°ã€‚ç¿»çœ‹ä»£ç ï¼Œå‘ç°è¿™ä¸ªåˆ†æ”¯ä¸å¯è¾¾ã€‚æœ‰äº›å¥‡æ€ªï¼Œå›å¤´å†ç ”ç©¶ç ”ç©¶ã€‚

æœ¬æƒ³è¿™ä¸€ç¯‡æ–‡ç« æŠŠ Hessian åºåˆ—åŒ–åè®®å‰©ä¸‹çš„å†…å®¹éƒ½è§£é‡Šå®Œï¼Œä½†æ˜¯éšç€æµ‹è¯•çš„å¢åŠ ï¼Œå‘ç°å…³äºâ€œæ•°ç»„å’Œé›†åˆâ€çš„å†…å®¹å¤ªå¤šäº†ã€‚ç¯‡å¹…å·²ç»å¾ˆé•¿ï¼Œå‰©ä¸‹å†…å®¹å†å¼€å…¶ä»–æ–°ç¯‡å§ã€‚
