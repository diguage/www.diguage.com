---
title: "Redis æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆå››ï¼‰"
date: 2025-06-17T16:36:56+08:00
draft: false
keywords: ["Redis"]
tags: ["å­˜å‚¨","è®¾è®¡","æ¶æ„"]
categories: ["ç¨‹åºè®¾è®¡","ç®—æ³•","åˆ†å¸ƒå¼"]
thumbnail: "images/redis/redis-logo.png"
weight: 1
---

åœ¨ https://www.diguage.com/post/redis-core-data-structure-3/[Redis æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆä¸‰ï¼‰^] ä¸­ï¼Œé‡ç‚¹ä»‹ç»äº†ä¸€ä¸‹ Redis 7+ ä½¿ç”¨çš„åº•å±‚çš„æ•°æ®ç»“æ„ listpackã€‚æœ¬æ–‡é‡ç‚¹çœ‹ä¸€ä¸‹ï¼ŒRedis æ˜¯å¦‚ä½•åŸºäº listpack ä»¥åŠå…¶ä»–æ•°æ®ç»“æ„ç±»å‹æ¥æ„å»ºå¯¹å¤–æš´éœ²çš„äº”ä¸ªæ ¸å¿ƒæ•°æ®ç»“æ„çš„ã€‚

== quicklist

å…³äº quicklist æ›´è¯¦ç»†çš„ä»‹ç»ï¼Œè¯·çœ‹ https://www.diguage.com/post/redis-core-data-structure-1/#quicklist[Redis æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆä¸€ï¼šquicklist^]ã€‚

ä¸ä¸Šè¿°å†…å®¹ä¸ä¸€æ ·çš„åœ°æ–¹æ˜¯ï¼Œç°åœ¨çš„ quicklist åº•å±‚æ˜¯ä½¿ç”¨ listpack æ¥æ„å»ºçš„ï¼Œè€Œä¸æ˜¯ä¸Šè¿°å†…å®¹ä»‹ç»çš„ ziplistã€‚

== list

å…³äº `list-max-listpack-size` çš„è§£é‡Šï¼Œåœ¨æºç ä¸­æ‰¾åˆ°äº†è¯¦ç»†ä»‹ç»ï¼š

.`redis.conf`
[source%nowrap,bash,{source_attr}]
----
# Lists are also encoded in a special way to save a lot of space.
# The number of entries allowed per internal list node can be specified
# as a fixed maximum size or a maximum number of elements.
# For a fixed maximum size, use -5 through -1, meaning:
# -5: max size: 64 Kb  <-- not recommended for normal workloads
# -4: max size: 32 Kb  <-- not recommended
# -3: max size: 16 Kb  <-- probably not recommended
# -2: max size: 8 Kb   <-- good
# -1: max size: 4 Kb   <-- good
# Positive numbers mean store up to _exactly_ that number of elements
# per list node.
# The highest performing option is usually -2 (8 Kb size) or -1 (4 Kb size),
# but if your use case is unique, adjust the settings as necessary.
list-max-listpack-size -2
----

`list-max-listpack-size` é»˜è®¤ `-2` 8 Kbï¼›ä¹Ÿå¯ä»¥è®¾ç½®æˆ `-1`ï¼Œ 4 Kbï¼Œä¹Ÿæ˜¯æ¨èçš„å€¼ã€‚æ²¡æƒ³åˆ°è¿™ä¸ªå€¼ç«Ÿç„¶ä¼šå½±å“åˆ° list ä¸­ listpack åˆ° quicklist çš„è½¬æ¢æ¡ä»¶ã€‚

[source%nowrap,bash,{source_attr}]
----
$ redis-cli --raw

127.0.0.1:6379> RPUSH names diguage "Dç“œå“¥" "https://www.diguage.com/"
3

127.0.0.1:6379> LRANGE names 0 -1
diguage
Dç“œå“¥
https://www.diguage.com/

127.0.0.1:6379> TYPE names
list

127.0.0.1:6379> OBJECT encoding names
listpack

#...

# åŠ åˆ° 800 å¤šä¸ªå…ƒç´ åï¼Œlist çš„ç¼–ç æ–¹å¼ç»ˆäºå˜æˆäº† quicklist
127.0.0.1:6379> RPUSH names 1234567890 ...
836
127.0.0.1:6379> OBJECT encoding names
quicklist
----

.`t_list.c`
[source%nowrap,c,{source_attr}]
----
// server.list_max_listpack_size åº”è¯¥å°±æ˜¯ä¸Šé¢ list-max-listpack-size
// Dç“œå“¥æ·»åŠ äº† 800 å¤šä¸ªå…ƒç´ æ‰å‘ç”Ÿäº†è½¬å˜ï¼Œæ¯ä¸ªå…ƒç´ å¹³å‡å¤§æ¦‚æ˜¯ 10 ä¸ªå­—ç¬¦ï¼Œå¤§å°å¯ä»¥å¯¹å¾—ä¸Šã€‚
if (quicklistNodeExceedsLimit(server.list_max_listpack_size,
        lpBytes(o->ptr) + add_bytes, lpLength(o->ptr) + add_length))
{
    /* Invoke callback before conversion. */
    if (fn) fn(data);

    quicklist *ql = quicklistNew(server.list_max_listpack_size, server.list_compress_depth);

    /* Append listpack to quicklist if it's not empty, otherwise release it. */
    if (lpLength(o->ptr))
        quicklistAppendListpack(ql, o->ptr);
    else
        lpFree(o->ptr);
    o->ptr = ql;
    o->encoding = OBJ_ENCODING_QUICKLIST;
}
----

æ ¹æ®æµ‹è¯•å’Œä¸Šè¿°ä»£ç å¯ä»¥æ¨æ–­ï¼š*åœ¨ list ä¸­å…ƒç´ å¤§å°è¾¾åˆ° 8 Kb æ—¶ï¼Œç¼–ç å°±ä¼šä» listpack è½¬å˜ä¸º quicklistã€‚*

TIP: ğŸ“¢ï¼šè¿™ç‚¹å’Œæ—§ç‰ˆçš„ Redis ä¸å¤ªä¸€æ ·ï¼šæ—§ç‰ˆ Redis ç›´æ¥ä½¿ç”¨ quicklist æ¥å­˜å‚¨å…ƒç´ ã€‚è€Œ Redis 7+ï¼Œå°æ‰¹é‡æ•°æ®ä½¿ç”¨ listpack å­˜ï¼Œè¾¾åˆ°ä¸€å®šæ¡ä»¶åï¼Œæ‰å¼€å§‹ä½¿ç”¨ quicklist æ¥å­˜æ•°æ®ã€‚ç›¸æ¯”è€Œè¨€ï¼ŒRedis 7+ å†…å­˜åˆ©ç”¨ç‡æ›´é«˜ï¼Œæ•ˆç‡ä¹Ÿæ›´å¥½ï¼

== set

åœ¨é›†åˆ set ä¸­ï¼Œå­˜åœ¨ä¸‰ç§ç¼–ç æ–¹å¼ï¼Œè½¬å˜æ¡ä»¶æœ‰å¯¹åº”çš„é…ç½®é¡¹ï¼š

.`redis.conf`
[source%nowrap,bash,{source_attr}]
----
# å…ƒç´ æ•°é‡å°äº 128
set-max-listpack-entries 128
# æ‰€æœ‰å…ƒç´ é•¿åº¦å°äº 64
set-max-listpack-value 64
----

ä¸‹é¢æˆ‘ä»¬å¼€å§‹éªŒè¯ï¼š

[source%nowrap,bash,{source_attr}]
----
$ redis-cli --raw
127.0.0.1:6379> SADD numbers 1 2 3
3

127.0.0.1:6379> SMEMBERS numbers
1
2
3

127.0.0.1:6379> TYPE numbers
set

127.0.0.1:6379> OBJECT encoding numbers
intset

127.0.0.1:6379> SADD numbers "https://www.diguage.com"
1

127.0.0.1:6379> SMEMBERS numbers
1
2
3
https://www.diguage.com

127.0.0.1:6379> TYPE numbers
set

127.0.0.1:6379> OBJECT encoding numbers
listpack

127.0.0.1:6379> SADD numbers "1234567890123456789012345678901234567890123456789012345678901234"
1

127.0.0.1:6379> OBJECT encoding numbers
listpack

# ğŸ“¢ æ³¨æ„ï¼šå½“æ·»åŠ å…ƒç´ é•¿åº¦å¤§äº 64ï¼Œé‚£ä¹ˆç¼–ç å°±ä» listpack è½¬å˜æˆ hashtable
127.0.0.1:6379> SADD numbers "12345678901234567890123456789012345678901234567890123456789012345"
1

127.0.0.1:6379> OBJECT encoding numbers
hashtable
----

Redis çš„é›†åˆï¼ˆsetsï¼‰çš„åº•å±‚å­˜å‚¨å¯ä»¥ä½¿ç”¨ intsetã€ listpack å’Œ hashtableã€‚

å½“é›†åˆï¼ˆsetsï¼‰å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œé›†åˆï¼ˆsetsï¼‰ä½¿ç”¨ intset ç¼–ç ã€‚

. é›†åˆï¼ˆsetsï¼‰ä¿å­˜çš„æ‰€æœ‰å€¼éƒ½æ˜¯æ•´æ•°ï¼Œè€Œä¸”æ•°å­—èŒƒå›´åœ¨ -2^64^ ~ 2^64^-1 ä¹‹é—´ã€‚
. é›†åˆï¼ˆsetsï¼‰ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº 128 ä¸ªï¼Œï¼ˆé€šè¿‡ `set-max-intset-entries` å‚æ•°è°ƒèŠ‚ï¼Œé»˜è®¤æ˜¯ 128ï¼‰ã€‚

å½“å…ƒç´ æœ‰å­—ç¬¦ä¸²æ—¶ï¼Œå°±ä¼šä» intset è½¬æ¢æˆ listpackã€‚ä½¿ç”¨ listpack ç¼–ç å¿…é¡»æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ï¼š

. é›†åˆï¼ˆsetsï¼‰ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº 128 ä¸ªï¼Œï¼ˆé€šè¿‡ `set-max-intset-entries` å‚æ•°è°ƒèŠ‚ï¼Œé»˜è®¤æ˜¯ 128ï¼‰ã€‚
. é›†åˆï¼ˆsetsï¼‰ä¿å­˜çš„æ‰€æœ‰å…ƒç´ é•¿åº¦å°äº 64 ä¸ªå­—èŠ‚ï¼Œï¼ˆé€šè¿‡ `set-max-listpack-value` å‚æ•°æ¡ä»¶ï¼Œé»˜è®¤æ˜¯ 64ï¼‰ã€‚

å½“ä¸æ»¡è¶³è¦æ±‚æ—¶ï¼Œåˆ™ä» listpack è½¬å˜ä¸º hashtableã€‚

TIP: ğŸ“¢æ³¨æ„ï¼šset çš„å­˜å‚¨ä¹Ÿå’Œæ—§ç‰ˆå‘ç”Ÿäº†ä¸€ä¸‹å˜åŒ–ï¼šæ—§ç‰ˆçš„ Redis ä½¿ç”¨ intset å­˜æ•°å­—ï¼Œå½“æœ‰å­—ç¬¦ä¸²æ—¶ï¼Œç›´æ¥ä½¿ç”¨ hashtable æ¥å­˜å‚¨ï¼›è€Œ Redis 7+ å¼€å§‹ï¼Œå½“å­˜åœ¨å­—ç¬¦ä¸²æ—¶ï¼Œå…ˆä½¿ç”¨ listpack æ¥å­˜å…ƒç´ ï¼Œè¾¾åˆ°ä¸€å®šæ¡ä»¶åï¼Œæ‰ä¼šåˆ‡æ¢ä¸º hashtableã€‚ç›¸æ¯”è€Œè¨€ï¼ŒRedis 7+ å†…å­˜åˆ©ç”¨ç‡æ›´é«˜ï¼æŸ¥è¯¢æ•ˆç‡ä¸Šï¼Œå¯èƒ½ä¼šç•¥å·®ã€‚


== hash

hash çš„ç¼–ç ä¹Ÿæœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œè½¬æ¢æ¡ä»¶ä¹Ÿæœ‰å¯¹åº”çš„é…ç½®é¡¹ï¼š

.`redis.conf`
[source%nowrap,bash,{source_attr}]
----
# å…ƒç´ æ•°é‡å°äº 512
hash-max-listpack-entries 512
# æ‰€æœ‰å…ƒç´ é•¿åº¦å°äº 64
hash-max-listpack-value 64
----

å¼€å§‹éªŒè¯ï¼š

[source%nowrap,bash,{source_attr}]
----
$ redis-cli --raw
127.0.0.1:6379> HMSET profile name "Dç“œå“¥" site "https://www.diguage.com" job "Developer"
OK

127.0.0.1:6379> TYPE profile
hash

127.0.0.1:6379> OBJECT encoding profile
listpack

127.0.0.1:6379> HSET profile address "1234567890123456789012345678901234567890123456789012345678901234"
1

127.0.0.1:6379> HVALS profile
Dç“œå“¥
https://www.diguage.com
Developer
1234567890123456789012345678901234567890123456789012345678901234

127.0.0.1:6379> OBJECT encoding profile
listpack

# ğŸ“¢ æ³¨æ„ï¼šä¸‹é¢ç¼–ç æ ¼å¼å¼€å§‹å‘ç”Ÿå˜åŒ–äº†ï¼
127.0.0.1:6379> HSET profile address2 "12345678901234567890123456789012345678901234567890123456789012345"
1

127.0.0.1:6379> HVALS profile
Developer
Dç“œå“¥
1234567890123456789012345678901234567890123456789012345678901234
https://www.diguage.com
12345678901234567890123456789012345678901234567890123456789012345

127.0.0.1:6379> OBJECT encoding profile
hashtable
----

Redis çš„æ•£åˆ—ï¼ˆhashï¼‰çš„åº•å±‚å­˜å‚¨å¯ä»¥ä½¿ç”¨ listpack å’Œ hashtableã€‚å½“æ•£åˆ—ï¼ˆhashï¼‰å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œæ•£åˆ—ï¼ˆhashï¼‰ä½¿ç”¨ listpack ç¼–ç ã€‚

. æ•£åˆ—ï¼ˆhashï¼‰ä¿å­˜çš„æ‰€æœ‰é”®å€¼å¯¹çš„é”®å’Œå€¼çš„å­—ç¬¦ä¸²é•¿åº¦éƒ½å°äº 64 å­—èŠ‚ã€‚ï¼ˆé€šè¿‡å‚æ•° `hash-max-listpack-value` æ¥è°ƒèŠ‚ï¼Œé»˜è®¤æ˜¯ 64ï¼‰
. æ•£åˆ—ï¼ˆhashï¼‰ä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å°äº 512 ä¸ªã€‚ï¼ˆé€šè¿‡å‚æ•° `hash-max-listpack-entries` æ¥è°ƒèŠ‚ï¼Œé»˜è®¤æ˜¯ 512ï¼‰


== zset

zset çš„ç¼–ç ä¹Ÿæœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œè½¬æ¢æ¡ä»¶ä¹Ÿæœ‰å¯¹åº”çš„é…ç½®é¡¹ï¼š

.`redis.conf`
[source%nowrap,bash,{source_attr}]
----
# å…ƒç´ æ•°é‡å°äº 128
zset-max-listpack-entries 128
# æ‰€æœ‰å…ƒç´ é•¿åº¦å°äº 64
zset-max-listpack-value 64
----

[source,bash,{source_attr}]
----
$ redis-cli --raw
127.0.0.1:6379> ZADD NameRanking 1 "Dç“œå“¥"
1

127.0.0.1:6379> ZADD NameRanking 2 "https://www.diguage.com"
1

127.0.0.1:6379> ZADD NameRanking 3 "https://github.com/diguage"
1

127.0.0.1:6379> ZRANGE NameRanking 0 -1 WITHSCORES
Dç“œå“¥
1
https://www.diguage.com
2
https://github.com/diguage
3

127.0.0.1:6379> TYPE NameRanking
zset

127.0.0.1:6379> OBJECT encoding NameRanking
listpack

127.0.0.1:6379> ZADD NameRanking 4 "1234567890123456789012345678901234567890123456789012345678901234"
1

127.0.0.1:6379> ZRANGE NameRanking 0 -1 WITHSCORES
Dç“œå“¥
1
https://www.diguage.com
2
https://github.com/diguage
3
1234567890123456789012345678901234567890123456789012345678901234
4

127.0.0.1:6379> OBJECT encoding NameRanking
listpack

# ğŸ“¢ æ³¨æ„ï¼šä¸‹é¢ç¼–ç æ ¼å¼å¼€å§‹å‘ç”Ÿå˜åŒ–äº†ï¼
127.0.0.1:6379> ZADD NameRanking 5 "12345678901234567890123456789012345678901234567890123456789012345"
1

127.0.0.1:6379> ZRANGE NameRanking 0 -1 WITHSCORES
Dç“œå“¥
1
https://www.diguage.com
2
https://github.com/diguage
3
1234567890123456789012345678901234567890123456789012345678901234
4
12345678901234567890123456789012345678901234567890123456789012345
5

127.0.0.1:6379> OBJECT encoding NameRanking
skiplist

127.0.0.1:6379> TYPE NameRanking
zset
----

Redis çš„ zset çš„åº•å±‚å­˜å‚¨å¯ä»¥ä½¿ç”¨ listpack å’Œ skiplistã€‚å½“ zset å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œzset ä½¿ç”¨ listpack ç¼–ç ã€‚

. æœ‰åºé›†åˆä¿å­˜çš„å…ƒç´ æ•°é‡å°äº 128 ä¸ªï¼›ï¼ˆé€šè¿‡å‚æ•° `zset-max-listpack-entries` æ¥è°ƒèŠ‚ï¼Œé»˜è®¤ä¸º 128ã€‚ï¼‰
. æœ‰åºé›†åˆä¿å­˜çš„æ‰€æœ‰å…ƒç´ æˆå‘˜çš„é•¿åº¦éƒ½è¦å°äº 64 ä¸ªå­—èŠ‚ï¼›ï¼ˆé€šè¿‡å‚æ•° `zset-max-listpack-value` æ¥è°ƒèŠ‚ï¼Œé»˜è®¤ä¸º 64ã€‚ï¼‰

å…³äº skiplist çš„è¯¦ç»†ä»‹ç»ï¼Œè¯·çœ‹ï¼š https://www.diguage.com/post/redis-core-data-structure-2/#skiplist[Redis æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆäºŒï¼‰ï¼šskiplist^]ã€‚

== æ€»ç»“

Redis ä¸ºäº†èŠ‚çœå†…å­˜èµ„æºï¼Œåœ¨å…ƒç´ æ•°é‡è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä½¿ç”¨æ¯”è¾ƒèŠ‚çº¦å†…å­˜çš„æ•°æ®ç»“æ„ï¼Œå¤§éƒ¨åˆ†çš„æ•°æ®ç»“æ„æ˜¯ä» listpack å¼€å§‹çš„ï¼ˆset åœ¨åªæœ‰æ•°å­—çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä» intset å¼€å§‹ï¼‰ã€‚åœ¨å…ƒç´ è¾¾åˆ°ä¸€å®šæ¡ä»¶æ—¶ï¼Œæ‰ä¼šè½¬åŒ–æˆæ¯”è¾ƒå¤æ‚çš„æ•°æ®ç»“æ„ã€‚
