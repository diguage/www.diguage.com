---
title: "æ—¥å¿—æœ€ä½³å®è·µæ¢ç©¶"
date: 2021-07-14T10:52:58+08:00
draft: false
keywords: ["è½¯ä»¶å·¥ç¨‹","ç³»ç»Ÿæ¶æ„","å¼€å‘å·¥å…·",]
categories: ["è½¯ä»¶å·¥ç¨‹","ç³»ç»Ÿæ¶æ„","å¼€å‘å·¥å…·"]
tags: ["æ¶æ„","æºç åˆ†æ","æœ€ä½³å®è·µ"]
thumbnail: "images/logging/java-logging-icon.png"

weight: 1
---

:source-highlighter: rouge
:rouge-style: monokai
:source_attr: indent=0,subs="attributes,verbatim,quotes"
:image_attr: align=center,width=100%
:icons: font


åŠ å…¥å…¬å¸ä»¥æ¥ï¼Œå‚ä¸äº†å¾ˆå¤šä¸ªé¡¹ç›®çš„å¼€å‘ç»´æŠ¤ï¼›ä¹Ÿæ’æŸ¥å¤„ç†è¿‡å¾ˆå¤šçº¿ä¸Šé—®é¢˜ï¼›ä¸ºäº†å†™ Mock æµ‹è¯•ï¼Œä¹Ÿä¸“é—¨å»æ—¥å¿—ç³»ç»Ÿä¸Šæ‰’æ‹‰è¿‡ä¸å°‘æ—¥å¿—ç­‰ç­‰ã€‚åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¯¹æ—¥å¿—çš„è®¤è¯†æœ‰äº†ä¸å°‘æ›´æ·±åˆ»çš„è®¤è¯†å’Œä½“ä¼šã€‚ä¹Ÿå‘ç°ä¸å°‘é—®é¢˜ã€‚è¿™é‡Œå…ˆä»å­˜åœ¨çš„é—®é¢˜å±•å¼€è®ºè¿°ã€‚

== æ—¥å¿—å­˜åœ¨çš„é—®é¢˜

ä»ä¸ªäººçš„çœ¼å…‰ä¸Šæ¥çœ‹ï¼Œå½“å‰çš„ç³»ç»Ÿå­˜åœ¨å¦‚ä¸‹é—®é¢˜ï¼š

. å¿…è¦æ—¥å¿—æ²¡æœ‰æ‰“å°å‡ºæ¥ï¼Œå¯¼è‡´åœ¨è¿½è¸ªé—®é¢˜æˆ–æµ‹è¯•ä»£ç æ—¶ï¼Œå¸¦æ¥ä¸å¿…è¦çš„éº»çƒ¦ã€‚æ¯”å¦‚æŸ¥çœ‹ä¸€ä¸ªæ¥å£çš„è¿”å›å€¼ç”¨äº Mock æµ‹è¯•ï¼›å†æ¯”å¦‚ RPC è°ƒç”¨æŠ¥é”™ï¼Œè¿”å›å€¼ä»¥åŠé”™è¯¯ä¿¡æ¯æ²¡æœ‰æ‰“å°åˆ°æ—¥å¿—ä¸­ï¼Œä¸çŸ¥é“å…·ä½“é”™è¯¯åŸå› æ˜¯ä»€ä¹ˆã€‚
. æ—¥å¿—æŠ½å–ä¸­æ—¥å¿—è·¯å¾„é…ç½®é”™è¯¯ï¼Œå¯¼è‡´æ—¥å¿—é‡å¤æ”¶é›†ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å¤„ç†å’Œå­˜å‚¨æˆæœ¬ã€‚
. æ—¥å¿—ä»£ç ä¸è§„èŒƒï¼Œå¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½æ¶ˆè€—ï¼›æˆ–è€…å¤§ä¿ƒæ—¶ï¼Œæ—¥å¿—é™çº§ä¸ç”Ÿæ•ˆã€‚
. æ—¥å¿—æ¡†æ¶ç¹å¤šï¼Œé€ æˆé€ æˆå†²çªï¼Œé—æ¼éƒ¨åˆ†æ—¥å¿—ã€‚
. æ—¥å¿—é…ç½®ä¸è§„èŒƒï¼Œä¸åˆ©äºæ—¥å¿—çš„é‡‡é›†å’Œæ¸…æ´—ã€‚
. æ—¥å¿—å’Œè°ƒç”¨é“¾è·¯ç‰©ç†éš”ç¦»ï¼ŒæŸ¥çœ‹ä¸€ä¸ªè¯·æ±‚çš„æ•´ä¸ªè°ƒç”¨é“¾è·¯ä¸Šçš„æ—¥å¿—éå¸¸ä¸æ–¹ä¾¿ï¼Œä¸åˆ©äºé—®é¢˜çš„å¿«é€Ÿæ’æŸ¥å’Œå®šä½ã€‚

_å¤§å®¶çš„ç³»ç»Ÿä¸­ï¼Œå­˜åœ¨ä»€ä¹ˆæ ·çš„æ—¥å¿—é—®é¢˜ï¼Ÿæ¬¢è¿ç•™è¨€äº¤æµè®¨è®ºã€‚_

é’ˆå¯¹è¿™äº›é—®é¢˜ï¼Œæˆ‘è§‰å¾—æœ‰äº›åœ°æ–¹å€¼å¾—å‘åŠ›ä¸€ä¸‹ã€‚ç„¶åï¼Œåšäº†ä¸€äº›æ¢ç´¢ï¼Œæ€»ç»“ä¸€ä¸‹ï¼Œä»¥å¤‡åç»­ä½¿ç”¨ã€‚

== æ—¥å¿—æœ€ä½³å®è·µæ¢ç´¢

å¯¹äºæ—¥å¿—çš„ä½¿ç”¨ï¼Œç›¸ä¿¡æ‰€æœ‰çš„å¼€å‘äººå‘˜éƒ½æ¯”è¾ƒæ¸…æ¥šï¼Œç½‘ä¸Šä¹Ÿæœ‰å¤§é‡èµ„æ–™ï¼Œç›¸å…³æ—¥å¿—æ¡†æ¶çš„å®˜æ–¹æ–‡æ¡£ï¼Œä¹Ÿå†™çš„éå¸¸è¯¦å°½ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚

æœ¬æ–‡ä»ä¸€ä¸ªè§’åº¦å¯¹æ—¥å¿—è§„èŒƒè¿›è¡Œæ¢ç©¶ï¼š**åœ¨æ’æŸ¥é—®é¢˜æ—¶ï¼Œèƒ½å¦é€šè¿‡æ—¥å¿—æ¥å°½å¿«åœ°äº†è§£ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼Œå®šä½é—®é¢˜åŸå› ï¼Ÿ**å¦å¤–ï¼Œç”±äº Java çš„æ—¥å¿—æ¡†æ¶ç‰¹åˆ«å¤šï¼Œæœ‰ä¸€äº›æ¯”è¾ƒå®¹æ˜“è¿·æƒ‘çš„é—®é¢˜ï¼Œå°è¯•åšå‡ºä¸€ç‚¹æ€»ç»“ã€‚

ç³»ç»Ÿè¿è¡Œåï¼Œä¸ä¸¥æ ¼åœ°è¯´ï¼Œå†å»è§‚å¯Ÿç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼Œå°±ç±»ä¼¼äºåœ¨é»‘å¤œä¸­è¡Œèµ°ã€‚æ­¤æ—¶ï¼Œå‘ä½ æ‰”è¿‡æ¥ä¸€å—æ¿ç –ğŸ§±ï¼Œé‚£ä¹ˆï¼Œäº‹åå¦‚ä½•è¿½è´£å‘¢ï¼Ÿ

image::/images/logging/throw-bug.jpg[{image_attr}]

è¯·é—®ï¼šä½ èƒ½å¦æˆåŠŸèº²å¼€è¿™å—å«åš Bug çš„æ¿ç –ğŸ§±ï¼Ÿ

æ—¥å¿—ç”¨æ¥è®°å½•ç”¨æˆ·æ“ä½œã€ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ç­‰ï¼Œæ˜¯ä¸€ä¸ªç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚ç„¶è€Œï¼Œç”±äºæ—¥å¿—é€šå¸¸ä¸å±äºç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†æ˜¯åœ¨æ—¥å¿—å¯¹äºæ’æŸ¥é—®é¢˜ï¼Œæœ‰æ— å¯æ›¿ä»£çš„ä½œç”¨ï¼Œç†åº”å¾—åˆ°æ‰€æœ‰å¼€å‘äººå‘˜çš„é‡è§†ï¼ˆä¸é‡è§†ï¼Œæ€ä¹ˆç”©é”…ï¼Ÿï¼ï¼‰ï¼

[quote, Geshan Manandhar, Logging best practices]
____
If dog is a man's best friend,  +
logs are software engineer's best friend.
____

å¥½çš„æ—¥å¿—å¯ä»¥å¸®åŠ©ç³»ç»Ÿçš„å¼€å‘å’Œè¿ç»´äººå‘˜ï¼š

. äº†è§£çº¿ä¸Šç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€
. å¿«é€Ÿå‡†ç¡®å®šä½çº¿ä¸Šé—®é¢˜
. å‘ç°ç³»ç»Ÿç“¶é¢ˆ
. é¢„è­¦ç³»ç»Ÿæ½œåœ¨é£é™©
. æŒ–æ˜äº§å“æœ€å¤§ä»·å€¼
. å¯ä»¥å°†ä¸€ä¸ªæµç¨‹å®Œæ•´ä¸²èµ·æ¥ï¼ˆæ¯”å¦‚orderIdï¼‰
. â€¦â€¦

image::/images/logging/bug-goto-land.jpg[{image_attr}]

ä¸å¥½çš„æ—¥å¿—å¯¼è‡´ï¼š

. å¯¹ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ä¸€çŸ¥åŠè§£ï¼Œç”šè‡³ä¸€æ— æ‰€çŸ¥
. ç³»ç»Ÿå‡ºç°é—®é¢˜æ— æ³•å®šä½ï¼Œæˆ–è€…éœ€è¦èŠ±è´¹å·¨å¤§çš„æ—¶é—´å’Œç²¾åŠ›
. æ— æ³•å‘ç°ç³»ç»Ÿç“¶é¢ˆï¼Œä¸çŸ¥ä¼˜åŒ–ä»ä½•åšèµ·
. æ— æ³•åŸºäºæ—¥å¿—å¯¹ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­çš„é”™è¯¯å’Œæ½œåœ¨é£é™©è¿›è¡Œç›‘æ§å’ŒæŠ¥è­¦
. å¯¹æŒ–æ˜ç”¨æˆ·è¡Œä¸ºå’Œæå‡äº§å“ä»·å€¼æ¯«æ— å¸®åŠ©
. â€¦â€¦


æ—¥å¿—ä»åŠŸèƒ½æ¥è¯´ï¼Œå¯åˆ†ä¸ºè¯Šæ–­æ—¥å¿—ã€ç»Ÿè®¡æ—¥å¿—ã€å®¡è®¡æ—¥å¿—ã€‚ç»Ÿè®¡æ—¥å¿—ä¸€èˆ¬ç”±è¿ç»´ç»„è´Ÿè´£ï¼›è€Œå®¡è®¡æ—¥å¿—ï¼Œä¸€èˆ¬æ˜¯éœ€è¦é€šè¿‡ä»£ç æ¥å®ç°ã€‚è¿™é‡Œé‡ç‚¹æ¥è¯´è¯´è¯Šæ–­æ—¥å¿—ã€‚

è¯Šæ–­æ—¥å¿—ï¼Œ å…¸å‹çš„æœ‰ï¼š

* è¯·æ±‚å…¥å£å’Œå‡ºå£
* å¤–éƒ¨æœåŠ¡è°ƒç”¨å’Œè¿”å›
* èµ„æºæ¶ˆè€—æ“ä½œ: å¦‚è¯»å†™æ–‡ä»¶ç­‰
* å®¹é”™è¡Œä¸ºï¼š å¦‚äº‘ç¡¬ç›˜çš„å‰¯æœ¬ä¿®å¤æ“ä½œ
* ç¨‹åºå¼‚å¸¸ï¼š å¦‚æ•°æ®åº“æ— æ³•è¿æ¥
* åå°æ“ä½œï¼šå®šæœŸæ‰§è¡Œåˆ é™¤çš„çº¿ç¨‹
* å¯åŠ¨ã€å…³é—­ã€é…ç½®åŠ è½½

å¥½çš„æ—¥å¿—å°±åƒå¥½çš„æ–‡ç« ä¸€æ ·ï¼Œç»ä¸æ˜¯ä¸€éå°±å¯ä»¥å†™å¥½çš„ï¼Œè€Œéœ€è¦åœ¨å®é™…çš„è¿ç»´è¿‡ç¨‹ä¸­ï¼Œç»“åˆçº¿ä¸Šé—®é¢˜çš„å®šä½ï¼Œä¸æ–­åœ°è¿›è¡Œä¼˜åŒ–ã€‚æœ€å…³é”®çš„ä¸€ç‚¹æ˜¯ï¼Œ**å›¢é˜Ÿè¦é‡è§†æ—¥å¿—ä¼˜åŒ–è¿™ä»¶äº‹æƒ…ï¼Œä¸è¦è®©æ—¥å¿—çš„è´¨é‡æŒç»­é™ä½ï¼ˆå½“é¡¹ç›®å˜å¤§æ—¶ï¼Œé¡¹ç›®çš„ä»£ç ä¹Ÿå­˜åœ¨ä¸€æ ·çš„é—®é¢˜ï¼Œè¶Šå†™è¶Šä¹±ï¼‰ã€‚**

æ­¤å¤„æœ‰ä»¥ä¸‹å‡ ä¸ªæ¯”è¾ƒå¥½çš„å®è·µï¼š

. åœ¨å®šä½é—®é¢˜çš„è¿‡ç¨‹ä¸­å®Œå–„æ—¥å¿—ï¼Œå¦‚æœå®šä½é—®é¢˜èŠ±è´¹äº†å¾ˆé•¿æ—¶é—´ï¼Œé‚£å°±è¯´æ˜ç³»ç»Ÿæ—¥å¿—è¿˜å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥å®Œå–„å’Œä¼˜åŒ–ï¼›
. éœ€è¦æ€è€ƒæ˜¯å¦å¯ä»¥é€šè¿‡ä¼˜åŒ–æ—¥å¿—ï¼Œæ¥æå‰é¢„åˆ¤è¯¥é—®é¢˜æ˜¯å¦å¯èƒ½å‘ç”Ÿï¼ˆå¦‚æŸç§èµ„æºè€—å°½è€Œå¯¼è‡´çš„é”™è¯¯ï¼Œå¯ä»¥å¯¹èµ„æºçš„ä½¿ç”¨æƒ…å†µè¿›è¡Œè®°å½•ï¼‰
. å®šä¹‰å¥½æ•´ä¸ªå›¢é˜Ÿè®°å½•æ—¥å¿—çš„è§„èŒƒï¼Œä¿è¯æ¯ä¸ªå¼€å‘è®°å½•çš„æ—¥å¿—æ ¼å¼ç»Ÿä¸€ï¼›ç‰¹åˆ«éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå¯¹äºDEBUG/TRACEçº§åˆ«çš„æ—¥å¿—ï¼Œä¹Ÿéœ€è¦å®šä¹‰å¥½æ¸…æ™°çš„æ ¼å¼ï¼Œè€Œä¸æ˜¯ç”±å¼€å‘äººå‘˜è‡ªç”±å‘æŒ¥ï¼›
. æ•´ä¸ªå›¢é˜Ÿï¼ˆåŒ…æ‹¬å¼€å‘ï¼Œè¿ç»´å’Œæµ‹è¯•ï¼‰å®šæœŸå¯¹è®°å½•çš„æ—¥å¿—å†…å®¹è¿›è¡ŒReviewï¼›
. å¼€å‘åšè¿ç»´ï¼Œé€šè¿‡åœ¨æŸ¥é—®é¢˜çš„è¿‡ç¨‹æ¥ä¼˜åŒ–æ—¥å¿—è®°å½•çš„æ–¹å¼ï¼›
. è¿ç»´æˆ–æµ‹è¯•åœ¨æ—¥å¿—ä¸­å‘ç°çš„é—®é¢˜ï¼Œéƒ½éœ€è¦åŠæ—¶å‘å¼€å‘äººå‘˜åæ˜ ï¼›

== æ—¥å¿—æ¡†æ¶é€‰å‹


=== slf4j + logback

==== Jar åŒ…é€‰æ‹©


image::/images/logging/slf4j-bridging-legacy-apis.png[{image_attr},title="Slf4j æ¡¥æ¥å…¶ä»–æ—¥å¿—æ¡†æ¶",alt="Slf4j æ¡¥æ¥å…¶ä»–æ—¥å¿—æ¡†æ¶"]


.åŸºäº slf4j + logback çš„æ—¥å¿—æ¡†æ¶ä¾èµ–
[source,xml,{source_attr}]
----
<properties>
    <slf4j.version>1.7.30</slf4j.version>
    <log4j.version>2.13.3</log4j.version>
</properties>
 
<dependencies>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>slf4j-api</artifactId>
        <version>${slf4j.version}</version>
    </dependency>
    <dependency>
        <groupId>ch.qos.logback</groupId>
        <artifactId>logback-classic</artifactId>
        <version>1.2.3</version>
    </dependency>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>log4j-over-slf4j</artifactId>
        <version>${slf4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>jcl-over-slf4j</artifactId>
        <version>${slf4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>jul-to-slf4j</artifactId>
        <version>${slf4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.apache.logging.log4j</groupId>
        <artifactId>log4j-to-slf4j</artifactId>
        <version>${log4j.version}</version>
    </dependency>
</dependencies>
----


.logback æ—¥å¿—é…ç½®
[source,xml,{source_attr}]
----
<?xml version="1.0" encoding="UTF-8"?>
<configuration> 
    <!-- æ—¥å¿—æ–‡ä»¶ç›®å½• -->
    <property name="log.location" value="/export/Logs/ã€Šã€ŠAPP_NAMEã€‹ã€‹"/>
    <!-- æ—¥å¿—æ ·å¼ -->
    <property name="log.pattern" value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{80}[%L] - %msg%n"/>

    <!-- å°† JUL çš„æ—¥å¿—çº§åˆ«æ˜ å°„ä¸º logback çš„æ—¥å¿—çº§åˆ« -->
    <contextListener class="ch.qos.logback.classic.jul.LevelChangePropagator">
        <resetJUL>true</resetJUL>
    </contextListener>
 
    <!-- æ§åˆ¶å° -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder charset="UTF-8">
            <pattern>${log.pattern}</pattern>
        </encoder>
    </appender>
 
    <!-- å¦‚æœä½¿ç”¨ Spring Boot å‘å¸ƒåº”ç”¨ï¼Œåˆ™éœ€è¦é…ç½®è¯¥ Appenderã€‚ -->
    <!-- å¦‚æœä½¿ç”¨ Tomcat å‘å¸ƒåº”ç”¨ï¼Œåˆ™ä¸éœ€è¦é…ç½®è¯¥ Appenderã€‚ -->
    <appender name="CATALINA" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <!-- å¦‚æœé…ç½®äº†è¯¥ Appenderï¼Œåˆ™åœ¨ digger ä¸­åªéœ€è¦æ·»åŠ è¯¥æ—¥å¿—æ–‡ä»¶è·¯å¾„å³å¯ã€‚ -->
        <file>${log.location}/catalina.log</file>
        <append>true</append>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${log.location}/catalina.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy
                    class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>100</maxHistory>
        </rollingPolicy>
        <encoder charset="UTF-8">
            <pattern>${log.pattern}</pattern>
        </encoder>
    </appender>
 
    <appender name="APP" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${log.location}/app.log</file>
        <append>true</append>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${log.location}/app.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>30GB</totalSizeCap>
        </rollingPolicy>

        <encoder charset="UTF-8">
            <pattern>${log.pattern}</pattern>
        </encoder>
    </appender>

    <logger name="com.xxx" level="WARN"/>

    <root level="INFO">
        <!-- ä¸‹é¢ä¸‰é€‰ä¸€å³å¯ã€‚ -->
        <!-- å¦‚æœä½¿ç”¨ Tomcat å‘å¸ƒï¼Œå¦‚æœæƒ³è¦ Tomcat çš„æ—¥å¿—ï¼Œåˆ™ä½¿ç”¨åˆ™ç•™ä¸‹ CONSOLEã€‚ -->
        <!-- å¦‚æœä½¿ç”¨ Tomcat å‘å¸ƒï¼Œå¦‚æœä¸æƒ³è¦ Tomcat çš„æ—¥å¿—ï¼Œåˆ™ä½¿ç”¨åˆ™ç•™ä¸‹ APPã€‚ -->
        <!-- å¦‚æœä½¿ç”¨ Spring Boot å‘å¸ƒï¼Œåˆ™ç•™ä¸‹ CATALINAï¼› -->
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="APP"/>
        <appender-ref ref="CATALINA"/>
    </root>
</configuration>
----


=== slf4j + log4j 2


==== log4j 2 çš„ä¼˜åŠ¿

==== Jar åŒ…é€‰æ‹©


image::/images/logging/log4j2-whichjar.png[{image_attr},title="log4j 2 æ¡¥æ¥å…¶ä»–æ—¥å¿—æ¡†æ¶",alt="log4j 2 æ¡¥æ¥å…¶ä»–æ—¥å¿—æ¡†æ¶"]


.åŸºäº slf4j + log4j 2 çš„æ—¥å¿—æ¡†æ¶ä¾èµ–
[source,xml,{source_attr}]
----
<properties>
    <slf4j.version>1.7.30</slf4j.version>
    <log4j.version>2.13.3</log4j.version>
</properties>
 
 
<dependencies>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>slf4j-api</artifactId>
        <version>${slf4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.apache.logging.log4j</groupId>
        <artifactId>log4j-1.2-api</artifactId>
        <version>${log4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.apache.logging.log4j</groupId>
        <artifactId>log4j-slf4j-impl</artifactId>
        <version>${log4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.apache.logging.log4j</groupId>
        <artifactId>log4j-jcl</artifactId>
        <version>${log4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.apache.logging.log4j</groupId>
        <artifactId>log4j-jul</artifactId>
        <version>${log4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.apache.logging.log4j</groupId>
        <artifactId>log4j-core</artifactId>
        <version>${log4j.version}</version>
    </dependency>
</dependencies>
----



.logback æ—¥å¿—é…ç½®
[source,xml,{source_attr}]
----
// TODO
----


== å…¸å‹ä»£ç è¯„å®¡


[source,java,{source_attr}]
----
// é”™è¯¯ç¤ºä¾‹ï¼šæ— è®ºæ—¥å¿—æ˜¯å¦æ‰“å°å‡ºæ¥ï¼Œéƒ½ä¼šæ‰§è¡Œ toJson æ“ä½œï¼Œä½†æ˜¯ toJson è€—æ—¶å¾ˆé«˜ã€‚
log.info("å“åº”ç»“æœ: {}", toJson(proceed));


// æ­£ç¡®ç¤ºä¾‹
if (log.isInfoEnabled()) {
    log.info("å“åº”ç»“æœ:{}", toJson(proceed));
}
---- 

[source,java,{source_attr}]
----
// é”™è¯¯å®ä¾‹ï¼šæ‰‹åŠ¨æå‰å¼‚å¸¸æ¶ˆæ¯
log.error("error param: {}, result: {}, exception: {}", 
               toJson(param), toJson(result), exception.getMessage());
 
 
// æ­£ç¡®å®ä¾‹
log.error("error param: {}, result: {}", 
               toJson(paramDto), toJson(result), exception);
----


[source,java,{source_attr}]
----
// é”™è¯¯ç¤ºä¾‹ï¼šæ— æ„ä¹‰å‰ç¼€
log.info("##### æ˜µç§°: {}", name));


// æ­£ç¡®ç¤ºä¾‹
log.info("æ˜µç§°: {}", name));
---- 


== æ—¥å¿—å‚æ•°æ‹¼æ¥æ–¹æ³•

[source,java,{source_attr}]
----
package org.slf4j.helpers;
 
import java.text.MessageFormat;
import java.util.HashMap;
import java.util.Map;
 
final public class MessageFormatter {
    static final char DELIM_START = '{';
    static final char DELIM_STOP = '}';
    static final String DELIM_STR = "{}";
    private static final char ESCAPE_CHAR = '\\';
 
 
    // æ—¥å¿—å‚æ•°æ‹¼æ¥çš„æœ€ç»ˆå®ç°   
    final public static FormattingTuple arrayFormat(final String messagePattern, final Object[] argArray, Throwable throwable) {
 
        if (messagePattern == null) {
            return new FormattingTuple(null, argArray, throwable);
        }
 
        if (argArray == null) {
            return new FormattingTuple(messagePattern);
        }
 
        int i = 0;
        int j;
        // use string builder for better multicore performance
        StringBuilder sbuf = new StringBuilder(messagePattern.length() + 50);
 
        int L;
        for (L = 0; L < argArray.length; L++) {
 
            j = messagePattern.indexOf(DELIM_STR, i);
 
            if (j == -1) {
                // no more variables
                if (i == 0) { // this is a simple string
                    return new FormattingTuple(messagePattern, argArray, throwable);
                } else { // add the tail string which contains no variables and return
                    // the result.
                    sbuf.append(messagePattern, i, messagePattern.length());
                    return new FormattingTuple(sbuf.toString(), argArray, throwable);
                }
            } else {
                if (isEscapedDelimeter(messagePattern, j)) {
                    if (!isDoubleEscaped(messagePattern, j)) {
                        L--; // DELIM_START was escaped, thus should not be incremented
                        sbuf.append(messagePattern, i, j - 1);
                        sbuf.append(DELIM_START);
                        i = j + 1;
                    } else {
                        // The escape character preceding the delimiter start is
                        // itself escaped: "abc x:\\{}"
                        // we have to consume one backward slash
                        sbuf.append(messagePattern, i, j - 1);
                        deeplyAppendParameter(sbuf, argArray[L], new HashMap<Object[], Object>());
                        i = j + 2;
                    }
                } else {
                    // normal case
                    sbuf.append(messagePattern, i, j);
                    // åˆ¤æ–­éœ€è¦æ‹¼æ¥ï¼Œè¿™è°ƒç”¨å·¥å…·æ–¹æ³•ï¼Œè¿›è¡Œå‚æ•°æ‹¼æ¥
                    deeplyAppendParameter(sbuf, argArray[L], new HashMap<Object[], Object>());
                    i = j + 2;
                }
            }
        }
        // append the characters following the last {} pair.
        sbuf.append(messagePattern, i, messagePattern.length());
        return new FormattingTuple(sbuf.toString(), argArray, throwable);
    }
 
    // special treatment of array values was suggested by 'lizongbo'
    private static void deeplyAppendParameter(StringBuilder sbuf, Object o, Map<Object[], Object> seenMap) {
        if (o == null) {
            sbuf.append("null");
            return;
        }
        if (!o.getClass().isArray()) {
            // ç®€å•å¯¹è±¡ç›´æ¥æ‹¼æ¥
            safeObjectAppend(sbuf, o);
        } else {
            // check for primitive array types because they
            // unfortunately cannot be cast to Object[]
            if (o instanceof boolean[]) {
                booleanArrayAppend(sbuf, (boolean[]) o);
            } else if (o instanceof byte[]) {
                byteArrayAppend(sbuf, (byte[]) o);
            } else if (o instanceof char[]) {
                charArrayAppend(sbuf, (char[]) o);
            } else if (o instanceof short[]) {
                shortArrayAppend(sbuf, (short[]) o);
            } else if (o instanceof int[]) {
                intArrayAppend(sbuf, (int[]) o);
            } else if (o instanceof long[]) {
                longArrayAppend(sbuf, (long[]) o);
            } else if (o instanceof float[]) {
                floatArrayAppend(sbuf, (float[]) o);
            } else if (o instanceof double[]) {
                doubleArrayAppend(sbuf, (double[]) o);
            } else {
                objectArrayAppend(sbuf, (Object[]) o, seenMap);
            }
        }
    }
 
    // åŸºäº append æ¥å®ç°æ—¥å¿—å‚æ•°æ‹¼æ¥
    private static void safeObjectAppend(StringBuilder sbuf, Object o) {
        try {
            String oAsString = o.toString();
            sbuf.append(oAsString);
        } catch (Throwable t) {
            Util.report("SLF4J: Failed toString() invocation on an object of type [" + o.getClass().getName() + "]", t);
            sbuf.append("[FAILED toString()]");
        }
 
    }
}
----

== å¢åŠ  `TraceId` + `SpanId`

äº†è§£äº†ä¸€ä¸‹å†…éƒ¨çš„åˆ†å¸ƒå¼è¿½è¸ªæ¡†æ¶ï¼Œå¯ä»¥è·å¾—åˆ°åˆ†å¸ƒå¼è¿½è¸ªçš„ä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥ä»ä¸­å–å‡º `TraceId`ï¼›å¦å¤–ï¼Œç ”ç©¶äº†ä¸€ä¸‹ logback çš„æ—¥å¿—å¤„ç†ï¼Œå¯ä»¥å‘ç°å¯ä»¥é€šè¿‡ç»§æ‰¿ `MessageConverter` æ¥å®Œæˆå®šåˆ¶åŒ–ã€‚å¤§æ¦‚ä»£ç å¦‚ä¸‹ï¼š

[source,java,{source_attr}]
----
public class TraceMessageConverter extends MessageConverter {
    @Override
    public String convert(ILoggingEvent event) {
        // è·å– span
        long traceId = span.getTraceId();
        long spanId = span.getSpanId();
        String msg = super.convert(event);
        return "traceId=" + traceId + ", spanId=" + spanId + ", " + msg;
    }
}
----

è¿™æ ·çš„è¯ï¼Œå¦‚æœèƒ½æ‰“é€šåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿå’Œæ—¥å¿—ç³»ç»Ÿçš„å…³è”ï¼Œå°±å¯ä»¥å°†åˆ†å¸ƒå¼è¿½è¸ªå’Œæ—¥å¿—å…³è”èµ·æ¥äº†ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜ã€‚


== å‚è€ƒèµ„æ–™

. https://zhuanlan.zhihu.com/p/27363484[æœ€ä½³æ—¥å¿—å®è·µï¼ˆv2.0ï¼‰^]
. https://www.scalyr.com/blog/the-10-commandments-of-logging/[Logging Best Practices: The 13 You Should Know | Scalyr^]
. https://www.slideshare.net/geshan/logging-best-practices[Logging best practices^] -- PPT å¾ˆèµã€‚éœ€è¦ç§‘å­¦ä¸Šç½‘ã€‚
. http://www.slf4j.org/legacy.html[slf4j: Log4j Bridge^]
. http://logging.apache.org/log4j/log4j-2.11.2/faq.html#which_jars[log4j2: Which JAR files do I need?^]
. https://segmentfault.com/a/1190000020894316[åˆæ¢Logbackï¼šå­¦ä¼šçœ‹æ‡‚Logbacké…ç½®æ–‡ä»¶ - SegmentFault æ€å¦^]
. https://www.jianshu.com/p/546e9aace657[Javaæ—¥å¿—è®°å½•æœ€ä½³å®è·µ - ç®€ä¹¦^]
. https://mp.weixin.qq.com/s/6IzKu0_yG-4S619qmQE1pQ[æ—¥å¿—è§„èŒƒå¤šé‡è¦ï¼Œè¿™ç¯‡æ–‡ç« å‘Šè¯‰ä½ ï¼^]
. https://logging.apache.org/log4j/2.x/performance.html[log4j2: Performance^]

