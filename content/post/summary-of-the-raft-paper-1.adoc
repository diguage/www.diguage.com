---
title: "Raft è®ºæ–‡æ‘˜è¦ï¼ˆä¸€ï¼‰"
date: 2021-07-02T11:42:26+08:00
draft: false
tags: ["è®ºæ–‡","åˆ†å¸ƒå¼","ç®—æ³•","æ¶æ„"]
categories: ["åˆ†å¸ƒå¼","ç®—æ³•"]
thumbnail: "images/raft/solo.svg"

weight: 1
---

// :doctype: book
:source-highlighter: pygments
:pygments-style: monokai
:pygments-linenums-mode: table
:source_attr: indent=0,subs="attributes,verbatim,quotes,macros"
:image_attr: align=center,width=100%
:icons: font


å‰ä¸€æ®µæ—¶é—´ï¼Œåœ¨ä¸€æ¬¡å¼€ç»„ä¼šçš„æ—¶å€™ï¼Œç»™å°ç»„æˆå‘˜ç®€å•ä»‹ç»äº†ä¸€ä¸‹ Raft åè®®ã€‚å¤§æ¦‚å››å¹´å‰è¯»è¿‡ Raft çš„è®ºæ–‡ï¼Œè¿™æ¬¡åˆ†äº«çš„æ—¶å€™ï¼Œå¥½å¤šå¥½å¤šç»†èŠ‚éƒ½å¿˜äº†ã€‚æ‰€ä»¥ï¼Œå†æ¬¡æŠŠ https://raft.github.io/raft.pdf[ã€ŠIn Search of an Understandable Consensus Algorithmã€‹] è¿™ç¯‡è®ºæ–‡æ‰¾å‡ºæ¥ï¼Œé‡è¯»ä¸€éï¼Œåšä¸ªç¬”è®°å’Œæ‘˜è¦ï¼Œæ–¹ä¾¿åç»­å­¦ä¹ å’Œå¤ä¹ ã€‚

== Abstract

[quote]
Raft is a consensus algorithm for managing a replicated log. 

å¼€ç¯‡æ‘˜è¦å°±ç‚¹å‡ºäº† Raft çš„ç‰¹ç‚¹ï¼š Raft æ˜¯ä¸€ç§ç®¡ç†å¤åˆ¶æ—¥å¿—çš„å…±è¯†ç®—æ³•ã€‚

[quote]
In order to enhance understandability, Raft separates the key elements of consensus, such as leader election, log replication, and safety, and it enforcesa stronger degree of coherency to reduce the number of states that must be considered.

ä¸ºäº†å¢å¼ºå¯ç†è§£æ€§ï¼ŒRaft å°†å…±è¯†åˆ†è§£æˆå‡ ä¸ªå…³é”®å…ƒç´ ï¼Œä¾‹å¦‚ Leader é€‰ä¸¾ï¼Œæ—¥å¿—å¤åˆ¶ï¼Œä»¥åŠå®‰å…¨æ€§ç­‰ï¼›åŒæ—¶ï¼Œä¸ºäº†é™ä½éœ€è¦è€ƒè™‘çš„çŠ¶æ€çš„æ•°é‡ï¼Œè¿˜å¼ºåˆ¶å®æ–½äº†æ›´å¼ºçš„ä¸€è‡´æ€§ã€‚


== 1. Introduction

[quote]
Consensus algorithms allow a collection of machines to work as a coherent group that can survive the failures of some of its members.

å…±è¯†ç®—æ³•æ˜¯å°†ä¸€ç»„æœºå™¨ä½œä¸ºä¸€ä¸ªå·¥ä½œæ•´ä½“ï¼Œä»¥åº”å¯¹ä¸ªåˆ«æœºå™¨å®•æœºé€ æˆçš„ä¸å¯ç”¨æ€§ã€‚

[quote]
Paxos has dominated the discussion of consensus algorithms over the last decade.

åªä» <<chubby>> å‘è¡¨ä»¥åï¼Œå€ŸåŠ©äº Google åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé¢†åŸŸçš„å¼ºå¤§å½±å“åŠ›ï¼ŒPaxos ä¸€ä¸‹å­å°±æˆäº†å…±è¯†ç®—æ³•ä¸­çš„æ ¸å¿ƒï¼Œåœ¨å…±è¯†ç®—æ³•é¢†åŸŸå æ®ç»Ÿæ²»åœ°ä½ã€‚

[quote]
Paxos is quite difficult to understand, inspite of numerous attempts to make it more approachable.

å¦‚æœ Paxos å®¹æ˜“ç†è§£ï¼Œ Raft å¯èƒ½å°±ä¸ä¼šå‡ºç°äº†ã€‚å“ˆå“ˆå“ˆğŸ˜„

[quote]
Our approach was unusual in that our primary goal was **understandability**: could we define a consensus algorithm forpractical systems and describe it in a way that is significantly easier to learn than Paxos?

ä»è¿™å¥è¯ä¸­å¯ä»¥çœ‹å‡ºï¼Œæå‡º Raft çš„é¦–è¦ç›®çš„æ˜¯ï¼šå¯ç†è§£æ€§ï¼Œè¿™ä¸ªç›®æ ‡ç¡®å®éæ¯”å¯»å¸¸ã€‚

[quote]
It was important notjust for the algorithm to work, but for it to be obvious whyit works.

çŸ¥å…¶ç„¶ï¼Œä¹ŸçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚

[quote]
In designing Raft we applied specific techniques to improve understandability, including decomposition (Raftseparates leader election, log replication, and safety) and state space reduction (relative to Paxos, Raft reduces thedegree of nondeterminism and the ways servers can be inconsistent with each other).

ä¸ºäº†æé«˜ Raft çš„å¯ç†è§£æ€§ï¼Œä½œè€…ä½¿ç”¨äº†è§£è€¦å’Œå‡å°‘çŠ¶æ€ç©ºé—´ä¸¤ä¸ªæ–¹æ³•ã€‚

[quote]
____
It has several novel features:

* Strong leader
* Leader election: Raft uses randomized timers to elect leaders.
* Membership  changes: Raftâ€™s  mechanism  for changing the set of servers in the cluster uses a new **joint consensus** approach where the majorities oftwo different configurations overlap during transitions.
____


== 2. Replicated state machines

[quote]
Replicated state machines are used to solve a variety of fault tolerance problems in distributed systems.

[quote]
Ex-amples of replicated state machines include <<chubby>> and <<zookeeper>>.

[quote]
Replicated state machines are typically implementedusing a replicated log, as shown in Figure 1. Each serverstores a log containing a series of commands, which itsstate machine executes in order. Each log contains thesame commands in the same order, so each state ma-chine processes the same sequence of commands.

image::/images/raft/replicated-state-machine.png[{image_attr},title="å¤åˆ¶çŠ¶æ€æœº",alt="å¤åˆ¶çŠ¶æ€æœº"]

æ¯å°å¤åˆ¶çŠ¶æ€æœºå­˜å‚¨ç€åŒ…å«ä¸€ç³»åˆ—å‘½ä»¤çš„æ—¥å¿—ï¼Œè€Œä¸”è¿™äº›å‘½ä»¤æŒ‰ç…§é¡ºåºæ‰§è¡Œã€‚ç”±äºæ¯ä¸ªæ—¥å¿—åŒ…å«ç€ç›¸åŒç›¸åŒé¡ºåºçš„ç›¸åŒå‘½ä»¤ï¼Œæ‰€ä»¥æ¯ä¸ªæœºå™¨å°±å¤„ç†ç€ç›¸åŒé¡ºåºçš„å‘½ä»¤ï¼Œç»“æœå°±æ˜¯æ‰€æœ‰æœºå™¨æ‰§è¡Œçš„ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ã€‚

[quote]
Keeping the replicated log consistent is the job of theconsensus algorithm.

[quote]
____
Consensus algorithms for practical systems typicallyhave the following properties:

* They ensure **safety**(never returning an incorrect result) under all non-Byzantine conditions, includingnetwork delays, partitions, and packet loss, duplication, and reordering.
* They are fully functional (**available**) as long as anymajority of the servers are operational and can communicate with each other and with clients.
* They do not depend on timing to ensure the consistency of the logs: faulty clocks and extreme messagedelays can, at worst, cause availability problems.
* In the common case, a command can complete assoon as a majority of the cluster has responded to asingle round of remote procedure calls; a minority ofslow servers need not impact overall system perfor-mance.
____

æœ€åä¸€ç‚¹åˆ°æ—¶æ²¡æœ‰æƒ³åˆ°ã€‚æ¨æ•²ä¸€ä¸‹ï¼Œç¡®å®å¦‚æ­¤ï¼Œå“åº”å¿«çš„å¤šæ•°æ´¾æœºå™¨å·²ç»è¾¾æˆå…±è¯†ï¼Œè¿”å›å®¢æˆ·ç«¯ç»“æœäº†ã€‚æ•ˆåº”æ…¢çš„æœºå™¨ï¼Œåªè¦è·Ÿåœ¨åé¢è·‘å°±å¥½ã€‚

== 3. Whatâ€™s wrong with Paxos?

[quote]
Paxos first defines a protocol capable of reachingagreement on a single decision, such as a single replicatedlog entry. We refer to this subset assingle-decree Paxos.Paxos then combines multiple instances of this protocol tofacilitate a series of decisions such as a log (multi-Paxos).

Paxos ä¸ multi-Paxos ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

[quote]
____
Paxos has two significant drawbacks.

* The first drawback is that Paxos is exceptionally difficult to understand.
* The second problem with Paxos is that it does not provide a good foundation for building practical implementations
** One reason is that there is no widely agreedupon algorithm for multi-Paxos.
** Furthermore, the Paxos architecture is a poor one for building practical systems;
** Another problem is that Paxos uses a symmetric peer-to-peer approach at its core
____

Paxos çš„ä¸¤ä¸ªç¼ºç‚¹ï¼šéš¾ä»¥ç†è§£ å’Œ ç¼ºä¹è‰¯å¥½çš„æ„å»ºåŸºç¡€ã€‚

[quote]
If aseries of decisions must be made, it is simpler and fasterto first elect a leader, then have the leader coordinate thedecisions.

è¿™ç§æ–¹å¼æ›´ä¼˜ï¼Ÿè¿˜æ˜¯ Leader ä¸»å¯¼æ›´ä¼˜ï¼Ÿæœ‰å¾…ä¸“é—¨æ–‡ç« æ¥è®ºè¯ã€‚

[quote]
Each implementation begins with Paxos, discovers the difficulties in implementing it, and then develops a significantly different architecture.

<<chubby>> çš„è®ºæ–‡ä¸­ï¼Œä¼¼ä¹ä¹Ÿè¯å®äº†è¿™ä¸€ç‚¹ï¼š

[quote, The Chubby lock service for loosely-coupled distributed systems]
____
There are significant gaps between the description ofthe Paxos algorithm and the needs of a real-worldsystem. . . . the final system will be based on an un-proven protocol.
____

æœ‰æœºä¼šæŠŠ <<chubby>> çš„è®ºæ–‡ä¹Ÿè¯»ä¸€ä¸‹ã€‚

[bibliography]
== å‚è€ƒèµ„æ–™

* [[[chubby, Google Chubby]]] https://research.google.com/archive/chubby-osdi06.pdf[The Chubby lock service for loosely-coupled distributed systems]
* [[[zookeeper, Apache ZooKeeper]]] https://www.usenix.org/legacy/event/atc10/tech/full_papers/Hunt.pdf[ZooKeeper: Wait-free coordination for Internet-scale systems]